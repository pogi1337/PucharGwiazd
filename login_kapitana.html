<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logowanie Kapitanów</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: linear-gradient(135deg, #e0f2f7 0%, #bbdefb 100%); 
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }
        .container {
            max-width: 400px; padding: 30px; background: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-top: 5px solid #1565c0;
        }
        h2 { text-align: center; color: #1565c0; margin-bottom: 25px; }
        input[type="email"], input[type="password"] {
            width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #bdbdbd; border-radius: 8px; box-sizing: border-box; font-size: 1em;
        }
        .login-btn {
            background-color: #4caf50; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; width: 100%; margin-top: 15px;
            transition: background-color 0.3s;
        }
        .login-btn:hover { background-color: #388e3c; }
        .message-area { 
            padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 15px; text-align: center; border: 1px solid transparent;
        }
        .message-area.success { background-color: #e8f5e9; color: #388e3c; border-color: #a5d6a7; }
        .message-area.error { background-color: #ffebee; color: #d32f2f; border-color: #ef9a9a; }
    </style>
</head>
<body>

<div class="container">
    <h2>Logowanie Kapitanów Drużyn</h2>
    <form id="captain-login-form">
        <input type="email" id="captain-email" placeholder="Email" required>
        <input type="password" id="captain-password" placeholder="Hasło" required>
        <button type="submit" class="login-btn">Zaloguj się</button>
        <div id="login-message" class="message-area"></div>
    </form>
</div>

<script>
    // ===========================================
    // KONFIGURACJA FIREBASE
    // ===========================================
    const firebaseConfig = {
        apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
        authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
        databaseURL: "https://puchargwiazd-bdaa4-default-rtdb.europe-west1.firebasedatabase.app", // POPRAWIONE
        projectId: "puchargwiazd-bdaa4",
        storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
        messagingSenderId: "890734185883",
        appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Błąd inicjalizacji Firebase:", e.message);
    }

    const auth = firebase.auth();
    const loginForm = document.getElementById('captain-login-form');
    const messageArea = document.getElementById('login-message');

    // ===========================================
    // LOGIKA LOGOWANIA I PRZEKIEROWANIA
    // ===========================================

    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('captain-email').value;
        const password = document.getElementById('captain-password').value;

        messageArea.textContent = "Logowanie...";
        messageArea.className = "message-area";

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                // Pobierz token, aby uzyskać Custom Claim (teamId)
                user.getIdTokenResult(true) 
                    .then(idTokenResult => {
                        const teamId = idTokenResult.claims.teamId;
                        
                        if (teamId) {
                            messageArea.textContent = "Pomyślnie zalogowano! Przekierowanie...";
                            messageArea.className = "message-area success";
                            
                            // Przekierowanie do panelu po 1 sekundzie
                            setTimeout(() => {
                                window.location.href = "captain_panel.html"; 
                            }, 1000);

                        } else {
                            // Zalogowany, ale nie ma Claim 'teamId' - to nie jest konto kapitana
                            auth.signOut();
                            messageArea.textContent = "Błąd: To nie jest konto kapitana drużyny.";
                            messageArea.className = "message-area error";
                        }
                    })
                    .catch(error => {
                        console.error("Błąd tokena:", error);
                        auth.signOut();
                        messageArea.textContent = "Błąd weryfikacji. Spróbuj zalogować się ponownie.";
                        messageArea.className = "message-area error";
                    });
            })
            .catch(error => {
                let displayMessage = "Błąd logowania: Błędny email lub hasło.";
                 if (error.code === 'auth/network-request-failed') {
                     displayMessage = "Błąd: Brak połączenia z siecią.";
                }
                messageArea.textContent = displayMessage;
                messageArea.className = "message-area error";
                console.error("Firebase Auth Error:", error);
            });
    });

</script>

</body>
</html>
