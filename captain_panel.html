<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Kapitana</title>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        .player-card {
            border: 1px solid #ddd; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; background: #f9f9f9;
        }
        .player-card input {
            width: 100%; padding: 6px; margin: 4px 0;
        }
        .save-btn {
            background: #4CAF50; color: white; padding: 6px 12px;
            border: none; cursor: pointer; margin-top: 6px; border-radius: 6px;
        }
        .save-btn:hover { background: #45a049; }
        .logout { margin-top: 20px; color: red; cursor: pointer; }
    </style>
</head>
<body>

<h2>Panel Kapitana</h2>
<p id="team-name">Ładowanie...</p>

<h3>Zawodnicy</h3>
<div id="players-list"></div>

<p class="logout" onclick="logout()">Wyloguj</p>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
        authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
        projectId: "puchargwiazd-bdaa4",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ✅ WERYFIKACJA LOGOWANIA
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = "login_kapitana.html";
            return;
        }

        const uid = user.uid;

        // Pobierz dane użytkownika
        const doc = await db.collection("users").doc(uid).get();

        if (!doc.exists || doc.data().role !== "teamManager") {
            auth.signOut();
            window.location.href = "login_kapitana.html";
            return;
        }

        const teamId = doc.data().teamId;

        // Zapisz w localStorage
        localStorage.setItem("teamId", teamId);

        // Pobierz dane drużyny
        loadTeam(teamId);
        loadPlayers(teamId);
    });

    // ✅ Pobieranie drużyny
    async function loadTeam(teamId) {
        const teamDoc = await db.collection("teams").doc(teamId).get();
        if (!teamDoc.exists) return;

        document.getElementById("team-name").textContent =
            "Drużyna: " + teamDoc.data().name;
    }

    // ✅ Pobieranie zawodników
    async function loadPlayers(teamId) {
        const list = document.getElementById("players-list");
        list.innerHTML = "Ładowanie...";

        const snapshot = await db.collection("teams")
            .doc(teamId)
            .collection("players")
            .get();

        list.innerHTML = "";

        snapshot.forEach(player => {
            const p = player.data();

            const card = document.createElement("div");
            card.className = "player-card";

            card.innerHTML = `
                <label>Imię:</label>
                <input id="name-${player.id}" value="${p.name}">

                <label>Nazwisko:</label>
                <input id="surname-${player.id}" value="${p.surname}">

                <label>Numer:</label>
                <input id="number-${player.id}" value="${p.number}" type="number">

                <label>Pozycja:</label>
                <input id="position-${player.id}" value="${p.position}">

                <button class="save-btn" onclick="savePlayer('${teamId}','${player.id}')">Zapisz</button>
            `;

            list.appendChild(card);
        });
    }

    // ✅ ZAPISYWANIE ZMIAN
    async function savePlayer(teamId, playerId) {
        const name = document.getElementById(`name-${playerId}`).value;
        const surname = document.getElementById(`surname-${playerId}`).value;
        const number = document.getElementById(`number-${playerId}`).value;
        const position = document.getElementById(`position-${playerId}`).value;

        await db.collection("teams")
            .doc(teamId)
            .collection("players")
            .doc(playerId)
            .update({
                name,
                surname,
                number,
                position
            });

        alert("Zapisano zmiany!");
    }

    // ✅ WYLOGOWANIE
    function logout() {
        auth.signOut();
        window.location.href = "login_kapitana.html";
    }
</script>

</body>
</html>
