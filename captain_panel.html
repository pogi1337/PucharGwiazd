<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Kapitanów - Edycja Składu</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; background-color: #f7f7f7; }
        /* Style zostały skrócone dla czytelności, uzupełnij je z poprzednich fragmentów */
        .delete-btn { background-color: #dc3545; margin-left: 20px; }
        .section { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: white; border-radius: 6px; }
        .player-list { list-style: none; padding: 0; }
        .player-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
    </style>
</head>
<body>

<h1 id="main-title">Panel Kapitanów</h1>

<div class="section" id="player-management" style="display: none;">
    <h2 id="team-name-display">Edycja Składu dla: --</h2>
    
    <h3>Dodaj Nowego Zawodnika</h3>
    <input id="player-name-input" placeholder="Imię i Nazwisko Zawodnika">
    <button onclick="addPlayer()">Dodaj</button>
    
    <h3>Aktualny Skład</h3>
    <ul id="player-list" class="player-list">
        <li>Ładowanie składu...</li>
    </ul>
    <button onclick="logout()">Wyloguj</button>
</div>

<div id="access-denied" style="display: none; text-align: center;">
    <h2>Brak dostępu</h2>
    <p>Proszę zalogować się <a href="login_kapitan.html">tutaj</a>.</p>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
        authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
        databaseURL: "https://puchargwiazd-bdaa4-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "puchargwiazd-bdaa4",
        storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
        messagingSenderId: "890734185883",
        appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentTeamId = sessionStorage.getItem('loggedInTeamId'); 
    const TEAM_BASE_PATH = "teams/teams/"; // Ścieżka do danych drużyn

    if (!currentTeamId) {
        document.getElementById('player-management').style.display = 'none';
        document.getElementById('access-denied').style.display = 'block';
    } else {
        document.getElementById('player-management').style.display = 'block';
        document.getElementById("team-name-display").textContent = `Edycja Składu dla: ${currentTeamId}`;
        loadTeamPlayers(currentTeamId);
    }

    function loadTeamPlayers(teamId) {
        // POPRAWIONA ŚCIEŻKA
        const teamRef = db.ref(TEAM_BASE_PATH + teamId + "/players");
        teamRef.on("value", snapshot => {
            renderPlayers(snapshot.val());
        });
    }

    function renderPlayers(playersData) {
        const playerList = document.getElementById("player-list");
        playerList.innerHTML = "";

        if (!playersData) {
            playerList.innerHTML = "<li>Skład nieuzupełniony. Dodaj pierwszego zawodnika!</li>";
            return;
        }

        Object.values(playersData).forEach((player, index) => {
            // Używamy klucza, który jest autogenerowany przez Firebase.
            const playerId = Object.keys(playersData)[index];
            const listItem = document.createElement("li");
            listItem.innerHTML = `
                <span>${player.name}</span>
                <button class="delete-btn" onclick="deletePlayer('${playerId}')">Usuń</button>
            `;
            playerList.appendChild(listItem);
        });
    }

    function addPlayer() {
        const playerNameInput = document.getElementById("player-name-input");
        const playerName = playerNameInput.value.trim();

        if (!currentTeamId) return alert("Błąd sesji.");
        if (!playerName) return alert("Podaj imię i nazwisko zawodnika.");

        // POPRAWIONA ŚCIEŻKA
        db.ref(TEAM_BASE_PATH + currentTeamId + "/players").push({
            name: playerName
        });

        playerNameInput.value = ""; 
    }

    function deletePlayer(playerId) {
        if (!currentTeamId) return alert("Błąd sesji.");
        
        if (confirm("Czy na pewno chcesz usunąć tego zawodnika ze składu?")) {
            // POPRAWIONA ŚCIEŻKA
            db.ref(TEAM_BASE_PATH + currentTeamId + "/players/" + playerId).remove()
                .then(() => console.log("Zawodnika usunięto."))
                .catch(error => console.error("Błąd usuwania: ", error));
        }
    }
    
    function logout() {
        sessionStorage.removeItem('loggedInTeamId');
        window.location.href = "login_kapitan.html";
    }

</script>

</body>
</html>
