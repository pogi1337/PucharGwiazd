<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabele i Wyniki - Puchar Gwiazd</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // 1. KONFIGURACJA (Twoja)
        const HARDCODED_CONFIG = {
            apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
            authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
            projectId: "puchargwiazd-bdaa4",
            storageBucket: "puchargugwiazd-bdaa4.firebasestorage.app",
            messagingSenderId: "890734185883",
            appId: "1:890734185883:web:33e7f6e45b2a7095dfe53e"
        };

        // Inicjalizacja
        const app = initializeApp(HARDCODED_CONFIG);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const PATH_MATCHES = 'matches';

        // ============================================
        // 2. SZTYWNA LISTA DRUŻYN (ZMIANA ZGODNA Z PROŚBĄ)
        // ============================================
        const STATIC_TEAMS = [
            // GRUPA A
            { id: 'ga_1', name: 'Piorun Potaszniki', group: 'A' },
            { id: 'ga_2', name: 'PKS mięsne', group: 'A' },
            { id: 'ga_3', name: 'FC Dwójka', group: 'A' },
            { id: 'ga_4', name: 'Fc Hetman', group: 'A' },
            
            // GRUPA B
            { id: 'gb_1', name: 'Kokołaje', group: 'B' },
            { id: 'gb_2', name: 'Mistrzowie Remisu', group: 'B' },
            { id: 'gb_3', name: 'Down The Road', group: 'B' },
            { id: 'gb_4', name: 'Coco Jumbos', group: 'B' },

            // GRUPA C
            { id: 'gc_1', name: 'Łobuzy', group: 'C' },
            { id: 'gc_2', name: 'Champion Fc', group: 'C' },
            { id: 'gc_3', name: 'Goon Fc', group: 'C' },
            { id: 'gc_4', name: 'Czarne Perły Mozambiku', group: 'C' },

            // GRUPA D
            { id: 'gd_1', name: 'Dżołki', group: 'D' },
            { id: 'gd_2', name: 'Sławbud', group: 'D' },
            { id: 'gd_3', name: 'Młode Talenty', group: 'D' },
            { id: 'gd_4', name: 'Valentino Royal', group: 'D' }
        ];

        // Stan aplikacji
        let teamsMap = {}; // ID -> Nazwa
        let teamsDataRaw = []; // Surowe dane drużyn

        async function initApp() {
            try {
                await signInAnonymously(auth);
                loadTeamsAndMatches();
            } catch (e) {
                console.warn("Błąd logowania, próba odczytu publicznego...", e);
                loadTeamsAndMatches();
            }
        }

        function loadTeamsAndMatches() {
            // Zamiast pobierać z bazy, ładujemy zdefiniowane wyżej stałe
            teamsDataRaw = STATIC_TEAMS;
            teamsMap = {};
            
            // Budujemy mapę nazw dla szybkiego dostępu
            teamsDataRaw.forEach(t => {
                teamsMap[t.id] = t.name;
            });

            // Od razu ładujemy mecze (jeśli są w bazie)
            loadMatches();
        }

        function loadMatches() {
            const q = query(collection(db, PATH_MATCHES));

            onSnapshot(q, (snapshot) => {
                const matches = [];
                snapshot.forEach(doc => matches.push(doc.data()));
                
                // Oblicz statystyki na podstawie meczów
                const stats = calculateStats(matches, teamsDataRaw);
                
                // Wyświetl tabele
                renderTables(stats, matches);
            });
        }

        // ============================================
        // LOGIKA OBLICZANIA PUNKTÓW
        // ============================================
        function calculateStats(matches, teams) {
            // Inicjalizacja struktury dla każdej grupy
            const groups = {};
            
            // Przygotuj puste statystyki dla każdej drużyny
            teams.forEach(team => {
                const groupName = team.group || 'Bez Grupy';
                if (!groups[groupName]) groups[groupName] = {};
                
                groups[groupName][team.id] = {
                    name: team.name,
                    matches: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    points: 0
                };
            });

            // Przelicz wyniki z ZAKOŃCZONYCH meczów
            matches.forEach(m => {
                if (m.status === 'finished' || m.status === 'zakończony') {
                    // Próbujemy dopasować po ID lub po NAZWIE (dla kompatybilności ze statyczną listą)
                    let team1Id = m.team1Id;
                    let team2Id = m.team2Id;

                    // Fallback: jeśli w meczu są nazwy, a ID nie pasują do naszych statycznych ID, szukamy po nazwie
                    if (!teamsMap[team1Id]) {
                        const found1 = teamsDataRaw.find(t => t.name === m.teamA);
                        if (found1) team1Id = found1.id;
                    }
                    if (!teamsMap[team2Id]) {
                        const found2 = teamsDataRaw.find(t => t.name === m.teamB);
                        if (found2) team2Id = found2.id;
                    }

                    const group = m.group || 'Bez Grupy';
                    const g1 = parseInt(m.score1 || 0);
                    const g2 = parseInt(m.score2 || 0);

                    // Sprawdź czy drużyny istnieją w strukturze
                    if (groups[group] && groups[group][team1Id] && groups[group][team2Id]) {
                        const t1 = groups[group][team1Id];
                        const t2 = groups[group][team2Id];

                        t1.matches++; t2.matches++;
                        t1.goalsFor += g1; t1.goalsAgainst += g2;
                        t2.goalsFor += g2; t2.goalsAgainst += g1;

                        if (g1 > g2) {
                            t1.wins++; t1.points += 3;
                            t2.losses++;
                        } else if (g2 > g1) {
                            t2.wins++; t2.points += 3;
                            t1.losses++;
                        } else {
                            t1.draws++; t1.points += 1;
                            t2.draws++; t2.points += 1;
                        }
                    }
                }
            });
            
            return groups;
        }

        // ============================================
        // RENDEROWANIE TABEL
        // ============================================
        function renderTables(groupsStats, allMatches) {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';

            const sortedGroups = Object.keys(groupsStats).sort();

            if (sortedGroups.length === 0) {
                 container.innerHTML = '<p style="text-align:center">Brak danych do wyświetlenia.</p>';
                 return;
            }

            sortedGroups.forEach(groupName => {
                const groupTeams = Object.values(groupsStats[groupName]);
                
                // Sortowanie tabeli: Punkty > Różnica Bramek > Bramki Strzelone
                groupTeams.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    const goalDiffA = a.goalsFor - a.goalsAgainst;
                    const goalDiffB = b.goalsFor - b.goalsAgainst;
                    if (goalDiffB !== goalDiffA) return goalDiffB - goalDiffA;
                    return b.goalsFor - a.goalsFor;
                });

                // Generowanie HTML tabeli
                let tableRows = '';
                groupTeams.forEach((t, index) => {
                    const goalDiff = t.goalsFor - t.goalsAgainst;
                    // Wyróżnienie top 2 (np. awans)
                    const rowClass = index < 2 ? 'promotion-zone' : '';
                    
                    tableRows += `
                        <tr class="${rowClass}">
                            <td class="pos">${index + 1}</td>
                            <td class="team">${t.name}</td>
                            <td>${t.matches}</td>
                            <td>${t.wins}</td>
                            <td>${t.draws}</td>
                            <td>${t.losses}</td>
                            <td>${t.goalsFor}</td>
                            <td>${t.goalsAgainst}</td>
                            <td>${goalDiff}</td>
                            <td class="pts">${t.points}</td>
                        </tr>
                    `;
                });

                // Mecze dla tej grupy
                const groupMatches = allMatches.filter(m => (m.group === groupName) && (m.status === 'finished' || m.status === 'zakończony'));
                let matchesHtml = '';
                if (groupMatches.length > 0) {
                    matchesHtml = `<div class="matches-list"><h4>Wyniki Grupy ${groupName}</h4>`;
                    groupMatches.forEach(m => {
                        matchesHtml += `
                            <div class="match-row">
                                <span>${m.teamA}</span>
                                <span class="score">${m.score1} - ${m.score2}</span>
                                <span>${m.teamB}</span>
                            </div>
                        `;
                    });
                    matchesHtml += '</div>';
                }

                // Składanie sekcji grupy
                const section = document.createElement('div');
                section.className = 'group-section';
                section.innerHTML = `
                    <div class="group-header">GRUPA ${groupName}</div>
                    <div class="table-responsive">
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th class="team-head">Drużyna</th>
                                    <th>M</th>
                                    <th>W</th>
                                    <th>R</th>
                                    <th>P</th>
                                    <th>G+</th>
                                    <th>G-</th>
                                    <th>+/-</th>
                                    <th>PKT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    ${matchesHtml}
                `;
                container.appendChild(section);
            });
        }

        window.addEventListener('load', initApp);
        
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* =========================================
           STYL NOWOCZESNY - NEONOWY GRANAT
           ========================================= */
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #131a2a;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --live-red: #ff2a2a;
            --text-main: #ffffff;
            --text-sec: #a0aec0;
            --border: #1f2a40;
            --table-head: #1a233a;
            --table-row: #161e31;
            --table-row-alt: #131a2a;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* HEADER I NAV */
        .header {
            width: 100%; max-width: 1000px; padding: 20px; margin-top: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(19, 26, 42, 0.8); backdrop-filter: blur(10px);
            border-radius: 16px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10;
        }
        .header h1 {
            font-size: 1.8rem; font-weight: 900; letter-spacing: 1px; margin: 0;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .login-links a {
            color: var(--text-sec); text-decoration: none; font-weight: 600; font-size: 0.9rem;
            margin-left: 15px; transition: 0.3s;
        }
        .login-links a:hover { color: var(--accent); text-shadow: 0 0 8px var(--accent-glow); }

        #main-nav {
            margin: 20px 0 40px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
        }
        #main-nav a {
            color: var(--text-sec); text-decoration: none; font-weight: 600; font-size: 0.9rem;
            padding: 10px 20px; border-radius: 30px; border: 1px solid transparent;
            transition: 0.3s; background: var(--bg-card);
        }
        #main-nav a:hover {
            border-color: var(--accent); color: #fff;
            box-shadow: 0 0 15px var(--accent-glow); transform: translateY(-2px);
        }

        /* TABELE */
        .content-container { width: 100%; max-width: 1000px; padding: 0 20px; box-sizing: border-box; }
        
        .group-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; overflow: hidden; margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .group-header {
            background: linear-gradient(90deg, var(--bg-card), #1a233a);
            padding: 15px 25px; font-size: 1.4rem; font-weight: 800;
            color: var(--accent); border-bottom: 1px solid var(--border);
            text-transform: uppercase; letter-spacing: 1px;
        }

        .table-responsive { overflow-x: auto; }

        .standings-table {
            width: 100%; border-collapse: collapse; font-size: 0.9rem;
        }

        .standings-table th {
            background: var(--table-head); color: var(--text-sec);
            padding: 12px; text-align: center; font-weight: 600;
            text-transform: uppercase; font-size: 0.8rem;
        }
        .standings-table th.team-head { text-align: left; padding-left: 20px; }

        .standings-table td {
            padding: 12px; text-align: center; border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }
        .standings-table td.team { text-align: left; padding-left: 20px; font-weight: 600; }
        .standings-table td.pts { color: var(--accent); font-weight: 800; font-size: 1.1rem; }
        .standings-table td.pos { color: var(--text-sec); font-weight: 700; }

        .standings-table tr:last-child td { border-bottom: none; }
        .standings-table tr:hover td { background: rgba(255,255,255,0.03); }
        
        /* Strefa awansu */
        .promotion-zone td:first-child { 
            border-left: 3px solid var(--accent); 
        }

        /* Lista wyników w grupie */
        .matches-list {
            padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border);
        }
        .matches-list h4 { margin: 0 0 15px; color: var(--text-sec); font-size: 0.9rem; text-transform: uppercase; }
        
        .match-row {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px dashed var(--border); font-size: 0.9rem;
        }
        .match-row:last-child { border-bottom: none; }
        .match-row .score { font-weight: 800; color: var(--accent); letter-spacing: 2px; }

        /* FOOTER */
        .footer {
            margin-top: auto; padding: 40px 0; text-align: center; color: var(--text-sec); font-size: 0.85rem;
            border-top: 1px solid var(--border); width: 100%; background: #070a11; margin-top: 60px;
        }
        .social-media-links a { color: var(--text-sec); margin: 0 10px; font-size: 1.5rem; transition: 0.3s; }
        .social-media-links a:hover { color: #fff; transform: scale(1.2); display: inline-block; }

        #theme-toggle {
            position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px;
            border-radius: 50%; background: var(--bg-card); color: #fff; border: 1px solid var(--border);
            font-size: 1.2rem; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: 0.3s; display: flex; justify-content: center; align-items: center;
        }
        #theme-toggle:hover { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .standings-table th, .standings-table td { padding: 8px 4px; font-size: 0.8rem; }
            .standings-table th.team-head, .standings-table td.team { padding-left: 10px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>PUCHAR GWIAZD</h1>
        <div class="login-links">
            <a href="captain_panel.html"><i class="fas fa-user-shield"></i> KAPITAN</a>
            <a href="admin.html"><i class="fas fa-user-cog"></i> ADMIN</a>
        </div>
    </div>

    <nav id="main-nav">
        <a href="index.html">Strona Główna</a>
        <a href="druzyny.html">Drużyny</a>
        <a href="regulamin.html">Regulamin</a>
        <a href="tabela.html" style="background: var(--accent); color: var(--bg-dark);">Tabele</a>
        <a href="onas.html">O Nas</a>
    </nav>

    <div class="content-container" id="tables-container">
        <p style="text-align:center; margin-top:50px;">Ładowanie tabel...</p>
    </div>

    <div class="footer">
        <div class="social-media-links">
            <a href="#"><i class="fab fa-tiktok"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
        <p style="margin-top: 10px;">© 2025 Puchar Gwiazd. Wszystkie prawa zastrzeżone.</p>
    </div>

    <button id="theme-toggle"><i class="fas fa-moon"></i></button>

</body>
</html>
