<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kapitana - Puchar Gwiazd</title>

    <!-- Importy Firebase V11 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, onSnapshot, getDoc, doc, 
            addDoc, updateDoc, deleteDoc, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 1. KONFIGURACJA FIREBASE
        // ==========================================
        const HARDCODED_CONFIG = {
            apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
            authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
            projectId: "puchargwiazd-bdaa4",
            storageBucket: "puchargugwiazd-bdaa4.firebasestorage.app",
            messagingSenderId: "890734185883",
            appId: "1:890734185883:web:33e7f6e45b2a7095dfe53e"
        };

        const app = initializeApp(HARDCODED_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Ścieżki do głównych kolekcji
        const PATH_USERS = 'users';     
        const PATH_TEAMS = 'teams';

        let currentTeamId = "";

        // ==========================================
        // 2. LOGIKA UI I KOMUNIKATÓW
        // ==========================================
        
        function showMessage(text, type = 'success') {
            const msgDiv = document.getElementById('custom-message');
            if (!msgDiv) return;
            msgDiv.textContent = text;
            msgDiv.className = type === 'success' ? 'msg-success' : 'msg-error';
            msgDiv.style.display = 'block';
            setTimeout(() => msgDiv.style.display = 'none', 4000);
        }

        window.openModal = () => document.getElementById("addModal").style.display = "flex";
        window.closeModal = () => {
            document.getElementById("addModal").style.display = "none";
            document.getElementById("new-name").value = "";
            document.getElementById("new-surname").value = "";
            document.getElementById("new-number").value = "";
            document.getElementById("new-position").value = "";
        };
        
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error(error);
            }
        };

        // ==========================================
        // 3. LOGIKA APLIKACJI
        // ==========================================

        // A. Logowanie
        const loginForm = document.getElementById("login-form");
        if (loginForm) {
            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("email").value;
                const password = document.getElementById("password").value;
                const msgArea = document.getElementById("login-msg");

                msgArea.textContent = "Logowanie...";
                msgArea.className = "message-area";

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    msgArea.textContent = "";
                } catch (error) {
                    msgArea.textContent = "Błąd logowania: " + error.message;
                    msgArea.className = "message-area error-msg";
                }
            });
        }

        // B. Obsługa stanu uwierzytelnienia
        onAuthStateChanged(auth, async (user) => {
            const loading = document.getElementById("loading-screen");
            const loginView = document.getElementById("login-view");
            const panelView = document.getElementById("panel-view");

            if (user) {
                try {
                    // 1. Sprawdź czy user jest w kolekcji users
                    const userDocRef = doc(db, PATH_USERS, user.uid);
                    const docSnap = await getDoc(userDocRef);
                    
                    if (docSnap.exists()) {
                         const userData = docSnap.data();
                         
                         // Sprawdzamy czy jest teamManagerem
                         if (userData.role === "teamManager" || userData.role === "admin") { // Admin też może się tu zalogować
                            // JEST KAPITANEM
                            currentTeamId = userData.teamId;
                            
                            if
