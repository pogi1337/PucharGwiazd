<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Panel Admina - Wyniki i Dru≈ºyny</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Globalne style */
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 10px; 
            background-color: #e0f2f7; 
            color: #212121;
        }

        /* Kontenery */
        .login-box, .admin-panel { 
            max-width: 600px; 
            margin: 10px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
        }

        /* Og√≥lne kontrolki */
        input, select, button { 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 1em;
        }
        
        /* Sekcja Mecz√≥w (PC) */
        #teamA, #teamB {
            width: 49%; 
            display: inline-block;
        }

        /* Przyciski */
        button { 
            background-color: #007bff; 
            color: white; 
            cursor: pointer; 
            border: none; 
            width: 100%; 
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .delete-btn { 
            background-color: #dc3545; 
            width: auto !important;
        }
        .delete-btn:hover {
            background-color: #b02739;
        }

        h1 { color: #1565c0; margin-bottom: 20px; text-align: center; }
        h2 { border-bottom: 2px solid #64b5f6; padding-bottom: 5px; margin-top: 25px; color: #1565c0; }
        h3 { color: #007bff; margin-top: 15px; }
        
        .group-section { margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; }

        /* WERSJA DLA PC: Uk≈Çad meczu w jednym wierszu */
        .match-box { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            flex-wrap: nowrap; 
            border-radius: 6px;
            background-color: #f9f9f9;
        }

        .match-box > * { margin: 5px; }
        .match-box span { min-width: 150px; max-width: 200px; font-weight: bold; text-align: right; padding-right: 10px; }
        .match-box input[type="number"] { width: 40px; text-align: center; margin: 0 2px; padding: 5px; flex-shrink: 0; }
        .match-box button { padding: 8px 12px; width: auto; margin: 0 2px; flex-shrink: 0; }
        .match-box select { width: auto; flex-grow: 1; margin: 0 5px; }


        /* NOWE STYLE DLA ZARZƒÑDZANIA DRU≈ªYNAMI */
        .player-list, .achievements-list { list-style: none; padding: 0; }
        .player-list li, .achievements-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px dashed #eee; 
        }
        .player-number { font-weight: bold; color: #1565c0; margin-right: 10px; }
        .small-input { width: 49% !important; display: inline-block !important; }
        .ach-input-group { display: flex; gap: 10px; align-items: center; }
        .ach-input-group input { margin: 0; }
        .ach-input-group button { width: auto !important; padding: 8px 12px !important; margin: 0; }


        /* --- STYLY DLA URZƒÑDZE≈É MOBILNYCH (MAX SZEROKO≈öƒÜ 600px) --- */
        @media (max-width: 600px) {
            .login-box, .admin-panel { padding: 15px; }
            #teamA, #teamB { width: 100%; }

            /* Uk≈Çad meczy w panelu zarzƒÖdzania */
            .match-box { flex-direction: column; align-items: stretch; }
            .match-box > * { width: 100%; margin: 5px 0; text-align: center; }
            .match-box > span { min-width: unset; text-align: center !important; padding: 0; font-size: 1.1em; }

            /* Pasek Wynik√≥w i Zapisz */
            .score-controls { display: flex; justify-content: center; align-items: center; gap: 5px; width: 100%; margin: 5px 0; }
            .score-controls input { width: 60px; margin: 0; padding: 10px; }
            .score-controls button { width: auto; flex-grow: 1; margin: 0; }
            .match-box select, .match-box button.delete-btn { width: 100%; }

            /* ZarzƒÖdzanie dru≈ºynami (Telefon) */
            .small-input { width: 100% !important; display: block !important; }
            .achievements-list li { flex-direction: column; align-items: flex-start; }
            .achievements-list li button { width: 100%; margin-top: 5px; }
            .ach-input-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<div id="login-form" class="login-box">
    <h2>Logowanie Admina</h2>
    <input type="password" id="admin-password" placeholder="Has≈Ço Admina">
    <button onclick="loginAdmin()">Zaloguj</button>
</div>

<div id="admin-interface" class="admin-panel" style="display: none;">
    <h1>Panel Administracyjny</h1>

    <h2><i class="fas fa-futbol"></i> ZarzƒÖdzanie Meczami</h2>
    
    <h3>Dodaj mecz</h3>
    <select id="group">
        <option value="A">Grupa A</option>
        <option value="B">Grupa B</option>
        <option value="C">Grupa C</option>
        <option value="D">Grupa D</option>
    </select>
    <select id="status">
        <option value="scheduled">Zaplanowany</option>
        <option value="live">Na ≈ºywo</option>
        <option value="finished">Zako≈Ñczony</option>
    </select>
    <input id="teamA" placeholder="ID Dru≈ºyny A (np. Team1)" class="small-input">
    <input id="teamB" placeholder="ID Dru≈ºyny B (np. Team2)" class="small-input">
    <button onclick="addMatch()">Dodaj mecz</button>

    <h3>Lista mecz√≥w</h3>
    <div id="matches-output">
        ≈Åadowanie mecz√≥w...
    </div>

    <h2><i class="fas fa-users"></i> ZarzƒÖdzanie Dru≈ºynami</h2>
    <select id="team-selector" onchange="selectTeamToEdit(this.value)">
        <option value="" disabled selected>Wybierz dru≈ºynƒô...</option>
    </select>

    <div id="team-details-editor" style="display: none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
        <h3 id="editing-team-title">Edycja: </h3>

        <h4>OsiƒÖgniƒôcia <i class="fas fa-trophy"></i></h4>
        <div class="ach-input-group">
            <input id="achievement-input" placeholder="Wpisz osiƒÖgniƒôcie (np. Mistrz Ligi 2024)">
            <button onclick="addAchievement()">Dodaj</button>
        </div>
        <ul id="achievements-output" class="achievements-list"></ul>

        <h4>Sk≈Çad <i class="fas fa-user-friends"></i></h4>
        <div class="ach-input-group">
            <input id="player-number-admin-input" type="number" min="1" max="99" placeholder="Nr" class="small-input">
            <input id="player-name-admin-input" placeholder="Imiƒô i Nazwisko" class="small-input">
            <button onclick="addPlayerAdmin()">Dodaj</button>
        </div>
        <ul id="players-output" class="player-list"></ul>
    </div>

</div>

<script>
    // üîë HAS≈ÅO ADMINISTRATORA 
    const ADMIN_PASSWORD = "Kowalski12"; 
    const TEAM_BASE_PATH = "teams/teams/";
    let currentTeamIdAdmin = null;

    // Konfiguracja Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
        authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
        databaseURL: "https://puchargwiazd-bdaa4-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "puchargwiazd-bdaa4",
        storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
        messagingSenderId: "890734185883",
        appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===================================
    // FUNKCJE LOGOWANIA I G≈Å√ìWNE
    // ===================================

    function loginAdmin() {
        const enteredPassword = document.getElementById("admin-password").value;
        if (enteredPassword === ADMIN_PASSWORD) {
            document.getElementById("login-form").style.display = 'none';
            document.getElementById("admin-interface").style.display = 'block';
            loadAllTeams(); // ≈Åaduj listƒô dru≈ºyn po zalogowaniu
        } else {
            alert("Nieprawid≈Çowe has≈Ço administratora.");
        }
    }

    // ===================================
    // FUNKCJE ZARZƒÑDZANIA DRU≈ªYNAMI
    // ===================================

    function loadAllTeams() {
        const teamSelector = document.getElementById("team-selector");
        teamSelector.innerHTML = '<option value="" disabled selected>Wybierz dru≈ºynƒô...</option>';

        db.ref(TEAM_BASE_PATH).once('value', snapshot => {
            const teams = snapshot.val();
            if (!teams) return;

            Object.keys(teams).forEach(teamId => {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = teamId;
                teamSelector.appendChild(option);
            });
        });
    }

    function selectTeamToEdit(teamId) {
        currentTeamIdAdmin = teamId;
        if (teamId) {
            document.getElementById('editing-team-title').textContent = `Edycja: ${teamId}`;
            document.getElementById('team-details-editor').style.display = 'block';
            
            // Uruchom nas≈Çuchiwanie na zmiany w dru≈ºynie
            db.ref(TEAM_BASE_PATH + teamId).on('value', snapshot => {
                const teamData = snapshot.val();
                if (teamData) {
                    renderTeamDetails(teamData.players, teamData.achievements);
                } else {
                    renderTeamDetails(null, null);
                }
            });
        } else {
            document.getElementById('team-details-editor').style.display = 'none';
        }
    }

    function renderTeamDetails(playersData, achievementsData) {
        // RENDEROWANIE ZAWODNIK√ìW
        const playersOutput = document.getElementById("players-output");
        playersOutput.innerHTML = '';
        if (playersData) {
            const sortedPlayers = Object.entries(playersData).map(([id, player]) => ({
                id,
                ...player
            })).sort((a, b) => (a.number || 999) - (b.number || 999));

            sortedPlayers.forEach(player => {
                const listItem = document.createElement("li");
                const playerNumber = player.number !== undefined && player.number !== null ? player.number : '‚Äî'; 
                listItem.innerHTML = `
                    <span class="player-number">[${playerNumber}]</span>
                    <span>${player.name}</span>
                    <button class="delete-btn" onclick="deletePlayerAdmin('${player.id}')"><i class="fas fa-trash-alt"></i> Usu≈Ñ</button>
                `;
                playersOutput.appendChild(listItem);
            });
        } else {
             playersOutput.innerHTML = '<li>Brak zawodnik√≥w.</li>';
        }
        
        // RENDEROWANIE OSIƒÑGNIƒòƒÜ
        const achievementsOutput = document.getElementById("achievements-output");
        achievementsOutput.innerHTML = '';
        if (achievementsData) {
            Object.entries(achievementsData).forEach(([id, achievement]) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <span>${achievement}</span>
                    <button class="delete-btn" onclick="deleteAchievement('${id}')"><i class="fas fa-trash-alt"></i> Usu≈Ñ</button>
                `;
                achievementsOutput.appendChild(listItem);
            });
        } else {
             achievementsOutput.innerHTML = '<li>Brak osiƒÖgniƒôƒá.</li>';
        }
    }

    // Dodanie OsiƒÖgniƒôcia
    function addAchievement() {
        const achievementInput = document.getElementById("achievement-input");
        const achievementText = achievementInput.value.trim();

        if (!currentTeamIdAdmin) return alert("Wybierz dru≈ºynƒô.");
        if (!achievementText) return alert("Wpisz tre≈õƒá osiƒÖgniƒôcia.");

        // Dodanie do podwƒôz≈Ça 'achievements'
        db.ref(TEAM_BASE_PATH + currentTeamIdAdmin + "/achievements").push(achievementText)
            .then(() => achievementInput.value = '')
            .catch(error => alert("B≈ÇƒÖd dodawania osiƒÖgniƒôcia: " + error.message));
    }

    // Usuniƒôcie OsiƒÖgniƒôcia
    function deleteAchievement(achievementId) {
        if (!currentTeamIdAdmin) return alert("B≈ÇƒÖd sesji.");
        
        if (confirm("UsunƒÖƒá to osiƒÖgniƒôcie?")) {
            db.ref(TEAM_BASE_PATH + currentTeamIdAdmin + "/achievements/" + achievementId).remove()
                .then(() => console.log("OsiƒÖgniƒôcie usuniƒôto."))
                .catch(error => console.error("B≈ÇƒÖd usuwania: ", error));
        }
    }

    // Dodanie Zawodnika (Admin)
    function addPlayerAdmin() {
        const playerNameInput = document.getElementById("player-name-admin-input");
        const playerNumberInput = document.getElementById("player-number-admin-input");
        
        const playerName = playerNameInput.value.trim();
        const playerNumber = parseInt(playerNumberInput.value.trim());

        if (!currentTeamIdAdmin) return alert("Wybierz dru≈ºynƒô.");
        if (!playerName) return alert("Podaj imiƒô i nazwisko zawodnika.");
        
        if (isNaN(playerNumber) || playerNumber < 1 || playerNumber > 99) {
            return alert("üö® Proszƒô podaƒá prawid≈Çowy numer zawodnika (od 1 do 99).");
        }

        // Admin ma mo≈ºliwo≈õƒá dodania tego samego numeru, ale dla sp√≥jno≈õci sprawdzamy:
        db.ref(TEAM_BASE_PATH + currentTeamIdAdmin + "/players").once('value')
            .then(snapshot => {
                const players = snapshot.val();
                let numberTaken = false;
                for (let key in players) {
                    if (players[key].number === playerNumber) {
                        numberTaken = true;
                        break;
                    }
                }

                if (numberTaken && !confirm(`UWAGA: Numer ${playerNumber} jest ju≈º zajƒôty. Czy na pewno chcesz dodaƒá tego zawodnika?`)) {
                    return;
                }
                
                // ZAPIS DO BAZY
                db.ref(TEAM_BASE_PATH + currentTeamIdAdmin + "/players").push({
                    name: playerName,
                    number: playerNumber 
                });

                playerNameInput.value = ""; 
                playerNumberInput.value = "";
            });
    }

    // Usuniƒôcie Zawodnika (Admin)
    function deletePlayerAdmin(playerId) {
        if (!currentTeamIdAdmin) return alert("B≈ÇƒÖd sesji.");
        
        if (confirm("UsunƒÖƒá tego zawodnika?")) {
            db.ref(TEAM_BASE_PATH + currentTeamIdAdmin + "/players/" + playerId).remove()
                .then(() => console.log("Zawodnika usuniƒôto."))
                .catch(error => console.error("B≈ÇƒÖd usuwania: ", error));
        }
    }

    // ===================================
    // FUNKCJE ZARZƒÑDZANIA MECZAMI (BEZ ZMIAN W LOGICE)
    // ===================================

    function addMatch() {
        const group = document.getElementById("group").value;
        const status = document.getElementById("status").value;
        const a = document.getElementById("teamA").value.trim();
        const b = document.getElementById("teamB").value.trim();
        
        if (!group || !a || !b) return alert("Wybierz grupƒô i podaj ID obu dru≈ºyn!");

        const ref = db.ref("matches").push();
        ref.set({
            teamA: a,
            teamB: b,
            scoreA: 0,
            scoreB: 0,
            group: group,
            status: status
        }).then(() => {
            document.getElementById("teamA").value = '';
            document.getElementById("teamB").value = '';
        }).catch(error => {
            alert("B≈ÇƒÖd dodawania meczu: " + error.message);
        });
    }

    function generateStatusOptions(currentStatus) {
        const statuses = { 'scheduled': 'Zaplanowany', 'live': 'Na ≈ºywo', 'finished': 'Zako≈Ñczony' };
        let options = '';
        for (const [key, value] of Object.entries(statuses)) {
            const selected = key === currentStatus ? 'selected' : '';
            options += `<option value="${key}" ${selected}>${value}</option>`;
        }
        return options;
    }

    function updateScore(id) {
        const scoreA = document.getElementById(`a-${id}`).value;
        const scoreB = document.getElementById(`b-${id}`).value;
        db.ref("matches/" + id).update({
            scoreA: parseInt(scoreA) || 0,
            scoreB: parseInt(scoreB) || 0
        }).then(() => {
            console.log("Wynik zaktualizowany: " + id);
        }).catch(error => {
            alert("B≈ÇƒÖd aktualizacji wyniku: " + error.message);
        });
    }
    
    function updateStatus(id, newStatus) {
        db.ref("matches/" + id).update({ status: newStatus })
            .then(() => console.log("Status zaktualizowany: " + id))
            .catch(error => alert("B≈ÇƒÖd aktualizacji statusu: " + error.message));
    }

    function deleteMatch(id) {
        if (confirm("Czy na pewno chcesz usunƒÖƒá ten mecz? Tej operacji nie mo≈ºna cofnƒÖƒá!")) {
            db.ref("matches/" + id).remove()
                .then(() => console.log("Mecz usuniƒôty: " + id))
                .catch(error => alert("B≈ÇƒÖd usuwania meczu: " + error.message));
        }
    }

    // Nas≈Çuchiwanie na zmiany w bazie danych i renderowanie listy mecz√≥w
    db.ref("matches").on("value", snap => {
        const data = snap.val();
        const output = document.getElementById("matches-output");
        output.innerHTML = '';
        
        if (!data) {
            output.innerHTML = '<p style="text-align: center;">Brak mecz√≥w w bazie.</p>';
            return;
        }

        const groupedMatches = {};
        Object.entries(data).forEach(([id, match]) => {
            const groupName = match.group || 'Inne';
            if (!groupedMatches[groupName]) {
                groupedMatches[groupName] = [];
            }
            groupedMatches[groupName].push({ id, ...match });
        });
        
        const sortedGroupNames = Object.keys(groupedMatches).sort();

        sortedGroupNames.forEach(groupName => {
            let groupHtml = `<div class="group-section"><h3>Grupa ${groupName}</h3>`;
            
            groupedMatches[groupName].sort((a, b) => {
                const order = { 'live': 1, 'scheduled': 2, 'finished': 3 };
                return order[a.status] - order[b.status];
            }).forEach(match => {
                const statusOptions = generateStatusOptions(match.status);

                groupHtml += `
                    <div class="match-box">
                        <span>${match.teamA} vs ${match.teamB}</span>
                        
                        <div class="score-controls">
                            <input id="a-${match.id}" type="number" value="${match.scoreA}" min="0" max="99">
                            <input id="b-${match.id}" type="number" value="${match.scoreB}" min="0" max="99">
                            <button onclick="updateScore('${match.id}')">Zapisz Wynik</button>
                        </div>

                        <select onchange="updateStatus('${match.id}', this.value)">
                            ${statusOptions}
                        </select>
                        <button class="delete-btn" onclick="deleteMatch('${match.id}')">Usu≈Ñ Mecz</button>
                    </div>
                `;
            });
            groupHtml += `</div>`;
            output.innerHTML += groupHtml;
        });
    });

</script>
</body>
</html>
