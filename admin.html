<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administratora - Puchar Gwiazd</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(180deg, #0d1117, #0a0f1a);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    h2 {
      color: #00b7ff;
      border-bottom: 2px solid #007acc;
      padding-bottom: 4px;
    }
    .container, .panel {
      max-width: 500px;
      margin: 2rem auto;
      background: #161b22;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0, 183, 255, 0.2);
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      background: #0d1117;
      color: #fff;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 15px;
      margin-top: 5px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
    }
    button:hover {
      background: #00b7ff;
    }
    .message {
      margin-top: 10px;
      text-align: center;
    }
    .success {
      color: #4caf50;
    }
    .error {
      color: #ff5252;
    }
    section {
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #007acc;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #007acc;
      color: white;
    }
    @media (max-width: 600px) {
      .container, .panel { width: 90%; }
      h2 { font-size: 1.2em; }
      input, button { font-size: 1em; }
    }
  </style>
</head>
<body>

<!-- ‚úÖ LOGOWANIE -->
<div class="container" id="login-box">
  <h2>Logowanie admina</h2>
  <input id="login-email" type="email" placeholder="Email">
  <input id="login-pass" type="password" placeholder="Has≈Ço">
  <button id="login-btn">Zaloguj</button>
  <div id="login-msg" class="message"></div>
</div>

<!-- ‚úÖ PANEL ADMINA -->
<div class="panel" id="admin-wrapper" style="display:none;">

  <!-- ‚úÖ Tworzenie dru≈ºyny -->
  <section>
    <h2>Tworzenie konta dru≈ºyny</h2>
    <input id="team-id" placeholder="Nazwa dru≈ºyny">
    <input id="team-email" type="email" placeholder="Email dru≈ºyny">
    <input id="team-pass" type="password" placeholder="Has≈Ço (min. 6 znak√≥w)">
    <button id="create-team-btn">Utw√≥rz dru≈ºynƒô</button>
    <div id="team-msg" class="message"></div>
  </section>

  <!-- ‚úÖ Mecze -->
  <section>
    <h2>ZarzƒÖdzanie meczami</h2>
    <input id="match-teamA" placeholder="Dru≈ºyna A">
    <input id="match-teamB" placeholder="Dru≈ºyna B">
    <select id="match-group">
      <option value="A">Grupa A</option>
      <option value="B">Grupa B</option>
    </select>
    <button id="add-match-btn">Dodaj mecz</button>
    <div id="match-msg" class="message"></div>
    <div id="matches-list"></div>
  </section>

  <!-- ‚úÖ Tabela grupowa -->
  <section>
    <h2>Tabela grup</h2>
    <div id="tables"></div>
  </section>

  <!-- ‚úÖ Klasyfikacja strzelc√≥w -->
  <section>
    <h2>Klasyfikacja strzelc√≥w</h2>
    <div id="scorers"></div>
  </section>
</div>

<script>
  // üî• Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
    authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
    projectId: "puchargwiazd-bdaa4",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ‚úÖ Logowanie admina
  document.getElementById("login-btn").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value;
    const pass = document.getElementById("login-pass").value;
    const msg = document.getElementById("login-msg");

    msg.textContent = "Logowanie...";
    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      const doc = await db.collection("users").doc(cred.user.uid).get();

      if (!doc.exists || !doc.data().admin) {
        msg.textContent = "Brak uprawnie≈Ñ administratora.";
        msg.className = "message error";
        await auth.signOut();
        return;
      }

      msg.textContent = "Zalogowano!";
      msg.className = "message success";
      document.getElementById("login-box").style.display = "none";
      document.getElementById("admin-wrapper").style.display = "block";
      loadMatches();

    } catch (err) {
      msg.textContent = "B≈ÇƒÖd logowania: " + err.message;
      msg.className = "message error";
    }
  });

  // ‚úÖ Tworzenie dru≈ºyny
  document.getElementById("create-team-btn").addEventListener("click", async () => {
    const id = document.getElementById("team-id").value;
    const email = document.getElementById("team-email").value;
    const pass = document.getElementById("team-pass").value;
    const msg = document.getElementById("team-msg");
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await db.collection("teams").doc(id).set({
        name: id, email, managerUid: cred.user.uid, group: "A",
        points: 0, goalsFor: 0, goalsAgainst: 0
      });
      msg.textContent = "Dru≈ºyna dodana!";
      msg.className = "message success";
    } catch (e) {
      msg.textContent = "B≈ÇƒÖd: " + e.message;
      msg.className = "message error";
    }
  });

  // ‚úÖ Dodawanie meczu
  document.getElementById("add-match-btn").addEventListener("click", async () => {
    const a = document.getElementById("match-teamA").value;
    const b = document.getElementById("match-teamB").value;
    const g = document.getElementById("match-group").value;
    const msg = document.getElementById("match-msg");
    try {
      await db.collection("matches").add({
        teamA: a, teamB: b, goalsA: 0, goalsB: 0, group: g, status: "planowany", scorers: []
      });
      msg.textContent = "Mecz dodany!";
      msg.className = "message success";
      loadMatches();
    } catch (e) {
      msg.textContent = "B≈ÇƒÖd: " + e.message;
      msg.className = "message error";
    }
  });

  // ‚úÖ Wczytywanie i wy≈õwietlanie mecz√≥w
  async function loadMatches() {
    const list = document.getElementById("matches-list");
    list.innerHTML = "<p>≈Åadowanie mecz√≥w...</p>";
    const snap = await db.collection("matches").get();
    list.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      const div = document.createElement("div");
      div.style.border = "1px solid #007acc";
      div.style.padding = "10px";
      div.style.margin = "5px 0";
      div.style.borderRadius = "8px";
      div.innerHTML = `
        <b>${d.teamA}</b> ${d.goalsA} : ${d.goalsB} <b>${d.teamB}</b> (${d.group})<br>
        Status: ${d.status}<br>
        <button onclick="updateScore('${doc.id}', ${d.goalsA}, ${d.goalsB})">Zmie≈Ñ wynik</button>
        <button onclick="addScorer('${doc.id}')">Dodaj strzelca</button>
        <button onclick="deleteMatch('${doc.id}')">Usu≈Ñ</button>
      `;
      list.appendChild(div);
    });
    renderTables();
  }

  // ‚úÖ Edycja wyniku
  async function updateScore(id, gA, gB) {
    const a = prompt("Nowe gole dla dru≈ºyny A:", gA);
    const b = prompt("Nowe gole dla dru≈ºyny B:", gB);
    if (a === null || b === null) return;
    await db.collection("matches").doc(id).update({ goalsA: parseInt(a), goalsB: parseInt(b) });
    loadMatches();
  }

  // ‚úÖ Dodawanie strzelca
  async function addScorer(id) {
    const name = prompt("Imiƒô strzelca:");
    const team = prompt("Dru≈ºyna:");
    if (!name || !team) return;
    const matchRef = db.collection("matches").doc(id);
    await matchRef.update({ scorers: firebase.firestore.FieldValue.arrayUnion({ name, team }) });
    loadMatches();
  }

  // ‚úÖ Usuwanie meczu
  async function deleteMatch(id) {
    if (confirm("Na pewno usunƒÖƒá mecz?")) {
      await db.collection("matches").doc(id).delete();
      loadMatches();
    }
  }

  // ‚úÖ Renderowanie tabeli i strzelc√≥w
  async function renderTables() {
    const matches = (await db.collection("matches").get()).docs.map(d => d.data());
    const tablesDiv = document.getElementById("tables");
    const scorersDiv = document.getElementById("scorers");

    const tables = {}, scorers = {};

    for (const m of matches) {
      if (!tables[m.group]) tables[m.group] = {};
      for (const t of [m.teamA, m.teamB]) if (!tables[m.group][t]) tables[m.group][t] = { pts: 0, gf: 0, ga: 0 };
      tables[m.group][m.teamA].gf += m.goalsA;
      tables[m.group][m.teamB].gf += m.goalsB;
      tables[m.group][m.teamA].ga += m.goalsB;
      tables[m.group][m.teamB].ga += m.goalsA;
      if (m.goalsA > m.goalsB) tables[m.group][m.teamA].pts += 3;
      else if (m.goalsA < m.goalsB) tables[m.group][m.teamB].pts += 3;
      else tables[m.group][m.teamA].pts += 1, tables[m.group][m.teamB].pts += 1;

      if (m.scorers) {
        m.scorers.forEach(s => scorers[s.name] = (scorers[s.name] || 0) + 1);
      }
    }

    tablesDiv.innerHTML = "";
    for (const g in tables) {
      let html = `<h3>Grupa ${g}</h3><table><tr><th>Dru≈ºyna</th><th>PKT</th><th>GF</th><th>GA</th></tr>`;
      const sorted = Object.entries(tables[g]).sort((a,b)=>b[1].pts-a[1].pts);
      sorted.forEach(([t,v])=> html += `<tr><td>${t}</td><td>${v.pts}</td><td>${v.gf}</td><td>${v.ga}</td></tr>`);
      html += "</table>";
      tablesDiv.innerHTML += html;
    }

    const sortedScorers = Object.entries(scorers).sort((a,b)=>b[1]-a[1]);
    scorersDiv.innerHTML = "<table><tr><th>Zawodnik</th><th>Bramki</th></tr>" + 
      sortedScorers.map(([n,g])=>`<tr><td>${n}</td><td>${g}</td></tr>`).join("") + "</table>";
  }
</script>

</body>
</html>
