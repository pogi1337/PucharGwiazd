<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny - Puchar Gwiazd</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #dc3545;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --background-start: #e0f2f7;
            --background-end: #bbdefb;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        body { 
            font-family: 'Roboto', sans-serif; margin: 0; padding: 20px 10px; 
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%); 
            color: #212121; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh;
        }
        .header {
            width: 100%; max-width: 900px; margin-bottom: 30px; padding: 25px;
            background-color: #ffffff; border-radius: 15px;
            box-shadow: var(--card-shadow); border: 2px solid var(--primary-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 {
            font-family: 'Montserrat', sans-serif; color: var(--primary-color); font-size: 3.2em;
            margin-bottom: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .content-container {
            max-width: 900px; width: 100%; margin-bottom: 30px; padding: 25px;
            background: white; border-radius: 15px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25); border: 2px solid var(--primary-color);
        }
        .content-container h2 {
            font-family: 'Montserrat', sans-serif; color: var(--primary-color);
            margin-top: 10px; margin-bottom: 25px; padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color); font-weight: 700;
            font-size: 2.2em;
        }

        input[type="text"], input[type="email"], input[type="number"], input[type="password"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
            box-sizing: border-box; resize: vertical;
        }
        .select-group { display: flex; gap: 15px; align-items: flex-end; }
        .select-group > .form-group { flex: 1; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-row { display: flex; gap: 20px; }
        .team-score-group { flex: 1; }

        .submit-btn {
            background-color: var(--primary-color); color: white; padding: 12px 20px; border: none;
            border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold;
            transition: background-color 0.3s; margin-top: 10px;
            text-align: center;
        }
        .submit-btn:hover { background-color: #c82333; }
        .submit-btn.delete { background-color: #ffc107; color: #212529; }
        .submit-btn.delete:hover { background-color: #e0a800; }
        .submit-btn.live-toggle { background-color: #17a2b8; }
        .submit-btn.live-toggle:hover { background-color: #138496; }
        .submit-btn.live-toggle.active { background-color: var(--success-color); }
        .submit-btn.live-toggle.active:hover { background-color: #218838; }
        .submit-btn.generate { background-color: #007bff; }
        .submit-btn.generate:hover { background-color: #0056b3; }
        
        .player-entry { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .player-entry input[type="number"] { flex: 0 0 60px; }
        .player-entry input[type="text"] { flex: 1; }

        #edit-match-form > div { display: flex; gap: 15px; margin-top: 15px; }
        #edit-match-form button { flex: 1; }
        
        .match-live-status {
            font-size: 0.8em; padding: 3px 8px; border-radius: 3px; font-weight: bold; margin-left: 10px;
        }
        .match-live-status.live { background-color: var(--success-color); color: white; }
        .match-live-status.offline { background-color: #ffc107; color: #212529; }

        .message-area { padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 10px; text-align: center; }
        .message-area.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-area.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; word-break: break-word; }
        .message-area.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .subsection-header {
            font-size: 1.5em; color: var(--primary-color); margin-top: 25px; margin-bottom: 15px;
            border-bottom: 1px dashed #ccc; padding-bottom: 5px;
        }
        .subsection-header i { margin-right: 8px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header, .content-container { padding: 15px; margin-bottom: 20px; }
            .header h1 { font-size: 2.2em; }
            .content-container h2 { font-size: 1.8em; }
            .subsection-header { font-size: 1.3em; }

            .select-group, .form-row, #edit-match-form > div { flex-direction: column; gap: 10px; }
            .select-group > .form-group, .team-score-group, #edit-match-form button { flex: none; width: 100%; }
            .player-entry { flex-wrap: wrap; gap: 5px; }
            .player-entry input[type="number"] { flex: 0 0 50px; }
            .player-entry input[type="text"] { flex: 1 1 calc(100% - 70px); }
            .remove-player-btn { flex: 1 1 100%; }
            .submit-btn { padding: 10px 15px; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    
    <div class="header">
        <h1><i class="fas fa-lock"></i> Panel Administracyjny</h1>
    </div>

    <div class="content-container" id="login-section">
        <h2><i class="fas fa-sign-in-alt"></i> Logowanie Admina</h2>
        <form id="admin-login-form">
            <div class="form-group">
                <label for="admin-email">Email:</label>
                <input type="email" id="admin-email" value="kacpernwm77@gmail.com" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Hasło:</label>
                <input type="password" id="admin-password" required>
            </div>
            <button type="submit" class="submit-btn"><i class="fas fa-unlock-alt"></i> Zaloguj</button>
            <div id="login-message" class="message-area"></div>
        </form>
    </div>

    <div id="admin-panel" style="display: none; width: 100%;">
        
        <div class="content-container" id="match-score-entry">
            <h2><i class="fas fa-bullseye"></i> Wprowadź Wynik Meczu i Strzelców</h2>
            <form id="match-form">
                <div class="select-group">
                    <div class="form-group">
                        <label for="filter-group-score">Filtruj wg Grupy:</label>
                        <select id="filter-group-score" onchange="filterMatchSelect('match-id', this.value)">
                            <option value="">-- Wszystkie Grupy --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="match-id">Wybierz Mecz:</label>
                        <select id="match-id" required>
                            <option value="">-- Ładowanie meczów... --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group team-score-group">
                        <label for="home-score" id="home-team-label">Wynik Gospodarzy:</label>
                        <input type="number" id="home-score" min="0" value="0" required onchange="generateGoalSelectors('home')">
                    </div>
                    <div class="form-group team-score-group">
                        <label for="away-score" id="away-team-label">Wynik Gości:</label>
                        <input type="number" id="away-score" min="0" value="0" required onchange="generateGoalSelectors('away')">
                    </div>
                </div>
                
                <h3 class="subsection-header"><i class="fas fa-futbol"></i> Strzelcy Goli dla Gospodarzy</h3>
                <div id="home-goal-selectors"></div>

                <h3 class="subsection-header"><i class="fas fa-futbol"></i> Strzelcy Goli dla Gości</h3>
                <div id="away-goal-selectors"></div>

                <button type="submit" class="submit-btn" id="submit-match-score"><i class="fas fa-save"></i> Zapisz Wynik i Strzelców</button>
                <div id="match-message" class="message-area"></div>
            </form>
        </div>
        
        <div class="content-container" id="match-management">
            <h2><i class="fas fa-calendar-alt"></i> Zarządzanie Meczami</h2>
            <h3 class="subsection-header"><i class="fas fa-plus-circle"></i> Dodaj Nowy Mecz</h3>
            <form id="add-match-form">
                <div class="form-group">
                    <label for="new-match-id">ID Meczu (np. G1M1):</label>
                    <input type="text" id="new-match-id" required placeholder="Unikalne ID, np. FINAŁ">
                </div>
                <div class="select-group">
                    <div class="form-group">
                        <label for="new-match-group">Grupa:</label>
                        <input type="text" id="new-match-group" required placeholder="Grupa A, PlayOff, Finał...">
                    </div>
                    <div class="form-group">
                        <label for="new-home-team">Gospodarze:</label>
                        <select id="new-home-team" required><option value="">-- Ładowanie drużyn... --</option></select>
                    </div>
                    <div class="form-group">
                        <label for="new-away-team">Goście:</label>
                        <select id="new-away-team" required><option value="">-- Ładowanie drużyn... --</option></select>
                    </div>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-calendar-plus"></i> Dodaj Mecz</button>
                <div id="add-match-message" class="message-area"></div>
            </form>

            <h3 class="subsection-header" style="margin-top: 40px;"><i class="fas fa-edit"></i> Edytuj/Usuń Mecz i Live Status</h3>
            <div class="select-group">
                <div class="form-group">
                    <label for="filter-group-manage">Filtruj wg Grupy:</label>
                    <select id="filter-group-manage" onchange="filterMatchSelect('match-id-manage', this.value)">
                        <option value="">-- Wszystkie Grupy --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="match-id-manage">Wybierz Mecz do Edycji:</label>
                    <select id="match-id-manage" onchange="loadMatchDataForEdit(this.value)">
                        <option value="">-- Ładowanie meczów... --</option>
                    </select>
                </div>
            </div>

            <form id="edit-match-form" style="display: none;">
                <div class="form-group">
                    <label for="edit-match-id">ID Meczu (do zmiany):</label>
                    <input type="text" id="edit-match-id" required>
                </div>
                <div class="select-group">
                    <div class="form-group">
                        <label for="edit-match-group">Grupa:</label>
                        <input type="text" id="edit-match-group" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-home-team">Gospodarze:</label>
                        <select id="edit-home-team" required><option value="">-- Ładowanie drużyn... --</option></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-away-team">Goście:</label>
                        <select id="edit-away-team" required><option value="">-- Ładowanie drużyn... --</option></select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button type="submit" class="submit-btn" style="flex: 1;"><i class="fas fa-save"></i> Zapisz Zmiany w Meczu</button>
                    <button type="button" id="toggle-live-btn" class="submit-btn live-toggle" style="flex: 1;"><i class="fas fa-broadcast-tower"></i> Włącz/Wyłącz LIVE</button>
                    <button type="button" id="delete-match-btn" class="submit-btn delete" style="flex: 1;"><i class="fas fa-trash-alt"></i> Usuń Mecz</button>
                </div>
                <div id="edit-match-message" class="message-area"></div>
            </form>
        </div>
        
        <div class="content-container" id="team-management">
            <h2><i class="fas fa-users-cog"></i> Zarządzanie Drużynami</h2>

            <div class="form-group">
                <label for="select-team-manage">Wybierz Drużynę do Edycji:</label>
                <select id="select-team-manage">
                    <option value="">-- Wybierz drużynę --</option>
                </select>
            </div>

            <form id="edit-team-form" style="display: none;">
                <h3 class="subsection-header"><i class="fas fa-trophy"></i> Osiągnięcia Drużyny</h3>
                <div class="form-group">
                    <label for="team-achievements">Osiągnięcia (każde w nowej linii lub oddzielone przecinkami):</label>
                    <textarea id="team-achievements" rows="3" placeholder="Puchar 2024, Lider Strzelców, ..."></textarea>
                </div>

                <h3 class="subsection-header"><i class="fas fa-shirt"></i> Zawodnicy i Numery</h3>
                <div id="players-container">
                </div>
                
                <button type="button" class="submit-btn add-player-btn" id="add-player-btn"><i class="fas fa-user-plus"></i> Dodaj Zawodnika</button>

                <button type="submit" class="submit-btn" style="margin-top: 25px;"><i class="fas fa-save"></i> Zapisz Zmiany w Drużynie</button>
                <div id="edit-team-message" class="message-area"></div>
            </form>
        </div>

        <div class="content-container" style="text-align: center;">
            <button id="admin-logout-btn" class="submit-btn" style="background-color: var(--secondary-color);"><i class="fas fa-sign-out-alt"></i> Wyloguj</button>
        </div>

    </div>
    
    <div class="footer" style="width: 100%; max-width: 900px; text-align: center; padding: 15px 0; margin-top: 30px; color: var(--secondary-color); border-top: 1px solid #ccc;">
        <p>© 2025 Panel Admina Puchar Gwiazd.</p>
    </div>

<script>
    // ===========================================
    // KONFIGURACJA FIREBASE
    // ===========================================

    const firebaseConfig = {
        apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
        authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
        // !!! POPRAWIONY FORMAT URL dla SDK v8 (bez protokołu https://) !!!
        databaseURL: "puchargwiazd-bdaa4-default-rtdb.europe-west1.firebasedatabase.app/", 
        projectId: "puchargwiazd-bdaa4",
        storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
        messagingSenderId: "890734185883",
        appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
    };

    try {
        firebase.initializeApp(firebaseConfig); 
    } catch (e) {
        console.error("Błąd inicjalizacji Firebase (sprawdź klucze API i URL bazy danych):", e.message);
        // Kontynuacja bez Firebase, ale funkcje JS nie będą działać poprawnie
    }

    const auth = firebase.auth(); 
    const db = firebase.database();
    
    // ZMIENNE DANYCH I STAŁE ŚCIEŻEK
    let allTeamsData = {}; 
    let allMatchesData = {}; 
    let allGroups = new Set(); 
    let currentMatchTeams = {}; 
    
    const MATCHES_PATH = "matches"; 
    const TEAMS_PATH_ROOT = "teams"; 
    let currentLiveMatchId = null; 

    // ===========================================
    // AUTORYZACJA I START
    // ===========================================

    function checkAuth() {
        auth.onAuthStateChanged(user => {
            const loginSection = document.getElementById('login-section');
            const adminPanel = document.getElementById('admin-panel');
            
            if (user) {
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                loadMatchAndTeamData(); 
                loadTeamsForManagement();
            } else {
                loginSection.style.display = 'block';
                adminPanel.style.display = 'none';
                document.getElementById('admin-login-form').reset();
                document.getElementById('login-message').textContent = '';
            }
        });
    }

    document.getElementById('admin-login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('admin-email').value; 
        const password = document.getElementById('admin-password').value;
        const messageArea = document.getElementById('login-message');
        
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                messageArea.textContent = "Zalogowano pomyślnie!";
                messageArea.className = "message-area success";
            })
            .catch(error => {
                let displayMessage;
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        displayMessage = "Błąd: Błędny email lub hasło. Sprawdź, czy konto jest aktywne w Firebase Authentication.";
                        break;
                    case 'auth/network-request-failed':
                        displayMessage = "Błąd: Brak połączenia z internetem lub problem z serwerem Firebase.";
                        break;
                    case 'auth/invalid-credential':
                        displayMessage = "Błąd: Nieprawidłowe dane logowania (zwykle oznacza to błąd hasła lub emaila).";
                        break;
                    default:
                        displayMessage = "Błąd logowania: " + error.message + " (Kod błędu: " + error.code + ")."; 
                }
                messageArea.textContent = displayMessage;
                messageArea.className = "message-area error";
                console.error("Firebase Auth Error:", error);
            });
    });

    document.getElementById('admin-logout-btn').addEventListener('click', () => {
        auth.signOut().then(() => {
            document.getElementById('login-message').textContent = "Wylogowano.";
            document.getElementById('login-message').className = "message-area info";
        });
    });

    // ===========================================
    // LOGIKA APLIKACJI
    // ===========================================

    function loadMatchAndTeamData() {
        currentLiveMatchId = null;
        db.ref(TEAMS_PATH_ROOT).once('value').then(snapshot => {
            allTeamsData = snapshot.val() || {};
            populateTeamSelects();
            return db.ref(MATCHES_PATH).once('value');
        })
        .then(snapshot => {
            allMatchesData = snapshot.val() || {};
            Object.keys(allMatchesData).forEach(matchId => {
                // Sprawdzenie, który mecz jest LIVE, nadal jest potrzebne dla logiki przycisku LIVE
                if (allMatchesData[matchId].live) {
                    currentLiveMatchId = matchId;
                }
            });
            populateMatchSelects();
            loadTeamsForManagement(); 
        })
        .catch(error => console.error("Błąd ładowania danych:", error));
    }

    function populateTeamSelects() {
        const selects = ['new-home-team', 'new-away-team', 'edit-home-team', 'edit-away-team'];
        const teamOptions = ['<option value="">-- Wybierz drużynę --</option>'];
        Object.keys(allTeamsData).forEach(teamId => {
            const teamName = allTeamsData[teamId]?.name || teamId;
            teamOptions.push(`<option value="${teamId}">${teamName} (${teamId})</option>`);
        });

        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) select.innerHTML = teamOptions.join('');
        });
    }

    function populateMatchSelects() {
        allGroups.clear();
        const matchSelects = ['match-id', 'match-id-manage'];
        const groupFilters = ['filter-group-score', 'filter-group-manage'];

        matchSelects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">-- Wybierz mecz --</option>';

            Object.keys(allMatchesData).forEach(matchId => {
                const match = allMatchesData[matchId];
                const homeName = allTeamsData[match.homeTeamId]?.name || match.homeTeamId;
                const awayName = allTeamsData[match.awayTeamId]?.name || match.awayTeamId;
                const isLive = match.live ? `<span class="match-live-status live">LIVE</span>` : `<span class="match-live-status offline">OFFLINE</span>`;
                const groupName = match.group || 'Inne';
                allGroups.add(groupName);

                const option = document.createElement('option');
                option.value = matchId;
                option.dataset.home = match.homeTeamId;
                option.dataset.away = match.awayTeamId;
                option.dataset.group = groupName;
                option.dataset.live = match.live ? 'true' : 'false';
                
                option.innerHTML = `${matchId} (${groupName}): ${homeName} vs ${awayName} ${match.homeScore || 0}-${match.awayScore || 0} ${isLive}`;
                select.appendChild(option);
            });
        });

        const groupOptions = ['<option value="">-- Wszystkie Grupy --</option>'];
        Array.from(allGroups).sort().forEach(group => {
            groupOptions.push(`<option value="${group}">${group}</option>`);
        });

        groupFilters.forEach(id => {
            const select = document.getElementById(id);
            if (select) select.innerHTML = groupOptions.join('');
        });
        
        document.getElementById('edit-match-form').style.display = 'none';
        document.getElementById('match-id').removeEventListener('change', handleMatchScoreSelect);
        document.getElementById('match-id').addEventListener('change', handleMatchScoreSelect);
    }

    function filterMatchSelect(selectId, groupFilter) {
        const select = document.getElementById(selectId);
        if (!select) return;

        Array.from(select.options).forEach(option => {
            if (option.value === "") { 
                option.style.display = 'block';
                return;
            }
            const matchGroup = option.dataset.group;
            if (!groupFilter || matchGroup === groupFilter) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        select.value = ""; 
        if (selectId === 'match-id') {
            document.getElementById('home-goal-selectors').innerHTML = '';
            document.getElementById('away-goal-selectors').innerHTML = '';
        }
        if (selectId === 'match-id-manage') {
            document.getElementById('edit-match-form').style.display = 'none';
        }
    }

    function handleMatchScoreSelect(e) {
        const matchSelect = e.target;
        const selectedOption = matchSelect.options[matchSelect.selectedIndex];
        const homeId = selectedOption.dataset.home;
        const awayId = selectedOption.dataset.away;

        document.getElementById('home-goal-selectors').innerHTML = '';
        document.getElementById('away-goal-selectors').innerHTML = '';

        if (homeId && awayId) {
            currentMatchTeams = {
                home: { 
                    id: homeId, 
                    name: allTeamsData[homeId]?.name || homeId, 
                    players: allTeamsData[homeId]?.players || {}
                },
                away: { 
                    id: awayId, 
                    name: allTeamsData[awayId]?.name || awayId, 
                    players: allTeamsData[awayId]?.players || {}
                }
            };
            
            document.getElementById('home-team-label').textContent = `Wynik ${currentMatchTeams.home.name}:`;
            document.getElementById('away-team-label').textContent = `Wynik ${currentMatchTeams.away.name}:`;
            
            const match = allMatchesData[matchSelect.value];
            if (match) {
                document.getElementById('home-score').value = match.homeScore || 0;
                document.getElementById('away-score').value = match.awayScore || 0;
            }

            generateGoalSelectors('home');
            generateGoalSelectors('away');

        } else {
            currentMatchTeams = {};
            document.getElementById('home-team-label').textContent = 'Wynik Gospodarzy:';
            document.getElementById('away-team-label').textContent = 'Wynik Gości:';
            document.getElementById('home-score').value = 0;
            document.getElementById('away-score').value = 0;
        }
    }

    function generateGoalSelectors(teamType) {
        const matchId = document.getElementById('match-id').value;
        const match = allMatchesData[matchId];

        const scoreInput = document.getElementById(`${teamType}-score`);
        const score = parseInt(scoreInput.value) || 0;
        const container = document.getElementById(`${teamType}-goal-selectors`);
        container.innerHTML = '';
        
        if (!currentMatchTeams[teamType] || !match) return;

        const team = currentMatchTeams[teamType];
        const players = team.players || {};
        
        const currentScorers = match.scorers ? match.scorers.filter(s => s.teamType === teamType) : [];

        if (score === 0) {
            container.innerHTML = `<p style="color: #6c757d;">Drużyna ${team.name} nie strzeliła bramek.</p>`;
            return;
        }

        const playerArray = Object.values(players);
        playerArray.sort((a, b) => (a.number || 999) - (b.number || 999));

        let playerOptions = '<option value="">-- Wybierz strzelca --</option>';
        if (playerArray.length > 0) {
            playerOptions += playerArray.map(player => 
                `<option value="${player.name}">${player.number ? player.number + '. ' : ''}${player.name}</option>`
            ).join('');
        } else {
            playerOptions += '<option value="Brak Zawodników">Brak zawodników w składzie</option>';
        }

        for (let i = 1; i <= score; i++) {
            const goalDiv = document.createElement('div');
            goalDiv.classList.add('form-group', 'goal-entry');
            
            const defaultValue = currentScorers[i-1]?.scorerName || ""; 

            goalDiv.innerHTML = `
                <label>Bramka nr ${i} (${team.name}):</label>
                <select class="goal-scorer-select" data-team="${teamType}" required>
                    ${playerOptions}
                </select>
            `;
            setTimeout(() => {
                const selectElement = goalDiv.querySelector('.goal-scorer-select');
                if (selectElement) {
                    selectElement.value = defaultValue;
                }
            }, 0); 
            
            container.appendChild(goalDiv);
        }
    }

    document.getElementById('match-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveMatchScore();
    });

    function saveMatchScore() {
        const matchId = document.getElementById('match-id').value;
        const homeScore = parseInt(document.getElementById('home-score').value);
        const awayScore = parseInt(document.getElementById('away-score').value);
        const messageArea = document.getElementById('match-message');

        if (!matchId) {
            messageArea.textContent = "Wybierz mecz.";
            messageArea.className = "message-area error";
            return;
        }
        
        const scorers = [];
        let isValid = true;

        document.querySelectorAll('.goal-scorer-select').forEach(select => {
            if (!select.value || select.value === "Brak Zawodników") {
                isValid = false;
            }
            scorers.push({
                teamType: select.dataset.team,
                scorerName: select.value
            });
        });

        if (!isValid) {
            messageArea.textContent = "Uzupełnij brakujących strzelców (nie można wybrać 'Brak Zawodników').";
            messageArea.className = "message-area error";
            return;
        }

        const matchData = {
            homeScore: homeScore,
            awayScore: awayScore,
            scorers: scorers, 
            played: true 
        };
        
        if(allMatchesData[matchId]) {
            matchData.live = allMatchesData[matchId].live || false;
            matchData.group = allMatchesData[matchId].group || 'Brak Grupy';
            matchData.homeTeamId = allMatchesData[matchId].homeTeamId;
            matchData.awayTeamId = allMatchesData[matchId].awayTeamId;
        }

        db.ref(MATCHES_PATH).child(matchId).update(matchData)
            .then(() => {
                messageArea.textContent = `Wynik meczu ${matchId} (${homeScore}-${awayScore}) oraz lista strzelców zapisane pomyślnie.`;
                messageArea.className = "message-area success";
                
                loadMatchAndTeamData(); 
                document.getElementById('match-form').reset();

            })
            .catch(error => {
                messageArea.textContent = "Błąd zapisu w bazie danych: " + error.message;
                messageArea.className = "message-area error";
            });
    }

    document.getElementById('add-match-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const matchId = document.getElementById('new-match-id').value.toUpperCase().trim();
        const homeTeamId = document.getElementById('new-home-team').value;
        const awayTeamId = document.getElementById('new-away-team').value;
        const group = document.getElementById('new-match-group').value.trim();
        const messageArea = document.getElementById('add-match-message');

        if (!matchId || !homeTeamId || !awayTeamId || !group) {
            messageArea.textContent = "Uzupełnij wszystkie pola: ID, Grupa, Gospodarze, Goście.";
            messageArea.className = "message-area error";
            return;
        }

        if (homeTeamId === awayTeamId) {
            messageArea.textContent = "Błąd: Drużyny muszą być różne.";
            messageArea.className = "message-area error";
            return;
        }
        
        if (allMatchesData[matchId]) {
            messageArea.textContent = "Błąd: Mecz o takim ID już istnieje. Użyj innego ID.";
            messageArea.className = "message-area error";
            return;
        }

        const newMatchData = {
            homeTeamId: homeTeamId,
            awayTeamId: awayTeamId,
            group: group,
            homeScore: 0,
            awayScore: 0,
            scorers: [],
            played: false,
            live: false
        };

        db.ref(MATCHES_PATH).child(matchId).set(newMatchData)
            .then(() => {
                messageArea.textContent = `Mecz ${matchId} dodany pomyślnie.`;
                messageArea.className = "message-area success";
                document.getElementById('add-match-form').reset();
                loadMatchAndTeamData(); 
            })
            .catch(error => {
                messageArea.textContent = "Błąd dodawania meczu: " + error.message;
                messageArea.className = "message-area error";
            });
    });

    function loadMatchDataForEdit(matchId) {
        const editForm = document.getElementById('edit-match-form');
        const match = allMatchesData[matchId];
        const toggleLiveBtn = document.getElementById('toggle-live-btn');
        document.getElementById('edit-match-message').textContent = '';

        if (!matchId || !match) {
            editForm.style.display = 'none';
            return;
        }

        editForm.style.display = 'block';

        document.getElementById('edit-match-id').value = matchId; 
        document.getElementById('edit-match-group').value = match.group || '';
        document.getElementById('edit-home-team').value = match.homeTeamId || '';
        document.getElementById('edit-away-team').value = match.awayTeamId || '';
        
        if (match.live) {
            toggleLiveBtn.classList.add('active');
            toggleLiveBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> LIVE: Włączony (Kliknij, aby wyłączyć)';
        } else {
            toggleLiveBtn.classList.remove('active');
            toggleLiveBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> LIVE: Wyłączony (Kliknij, aby włączyć)';
        }
    }

    document.getElementById('edit-match-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const oldMatchId = document.getElementById('match-id-manage').value;
        const newMatchId = document.getElementById('edit-match-id').value.toUpperCase().trim();
        const homeTeamId = document.getElementById('edit-home-team').value;
        const awayTeamId = document.getElementById('edit-away-team').value;
        const group = document.getElementById('edit-match-group').value.trim();
        const messageArea = document.getElementById('edit-match-message');

        if (!oldMatchId || !newMatchId || !homeTeamId || !awayTeamId || !group) {
            messageArea.textContent = "Uzupełnij wszystkie pola.";
            messageArea.className = "message-area error";
            return;
        }
        if (homeTeamId === awayTeamId) {
            messageArea.textContent = "Błąd: Drużyny muszą być różne.";
            messageArea.className = "message-area error";
            return;
        }

        const matchDataToUpdate = {
            homeTeamId: homeTeamId,
            awayTeamId: awayTeamId,
            group: group
        };
        
        const currentMatch = allMatchesData[oldMatchId];
        if (currentMatch) {
            matchDataToUpdate.live = currentMatch.live || false;
            matchDataToUpdate.played = currentMatch.played || false;
            matchDataToUpdate.homeScore = currentMatch.homeScore || 0;
            matchDataToUpdate.awayScore = currentMatch.awayScore || 0;
            matchDataToUpdate.scorers = currentMatch.scorers || [];
        }

        if (oldMatchId === newMatchId) {
            db.ref(MATCHES_PATH).child(oldMatchId).update(matchDataToUpdate)
                .then(() => {
                    messageArea.textContent = `Mecz ${oldMatchId} pomyślnie zaktualizowany.`;
                    messageArea.className = "message-area success";
                    loadMatchAndTeamData();
                })
                .catch(error => {
                    messageArea.textContent = "Błąd aktualizacji: " + error.message;
                    messageArea.className = "message-area error";
                });
        } else {
            if (allMatchesData[newMatchId]) {
                messageArea.textContent = `Błąd: Nowe ID (${newMatchId}) już istnieje. Wybierz inne.`;
                messageArea.className = "message-area error";
                return;
            }
            db.ref(MATCHES_PATH).child(newMatchId).set(matchDataToUpdate)
                .then(() => db.ref(MATCHES_PATH).child(oldMatchId).remove())
                .then(() => {
                    messageArea.textContent = `Mecz ${oldMatchId} pomyślnie przeniesiony do ID: ${newMatchId}.`;
                    messageArea.className = "message-area success";
                    loadMatchAndTeamData();
                    document.getElementById('edit-match-form').style.display = 'none';
                })
                .catch(error => {
                    messageArea.textContent = "Błąd zmiany ID: " + error.message;
                    messageArea.className = "message-area error";
                });
        }
    });

    document.getElementById('toggle-live-btn').addEventListener('click', function() {
        const matchId = document.getElementById('match-id-manage').value;
        const messageArea = document.getElementById('edit-match-message');
        if (!matchId) {
            messageArea.textContent = "Wybierz mecz, aby zmienić status LIVE.";
            messageArea.className = "message-area error";
            return;
        }

        const isLiveNow = allMatchesData[matchId]?.live || false;
        const newLiveStatus = !isLiveNow;
        let promise;

        if (newLiveStatus) {
            promise = db.ref(MATCHES_PATH).once('value')
                .then(snapshot => {
                    const allUpdates = {};
                    snapshot.forEach(child => {
                        const existingMatchId = child.key;
                        if (existingMatchId !== matchId && child.val().live) {
                            allUpdates[existingMatchId + '/live'] = false;
                        }
                    });
                    allUpdates[matchId + '/live'] = true; 
                    return db.ref(MATCHES_PATH).update(allUpdates);
                });

        } else {
            const updates = {};
            updates[matchId + '/live'] = false;
            promise = db.ref(MATCHES_PATH).update(updates);
        }

        promise
            .then(() => {
                loadMatchAndTeamData(); 
                loadMatchDataForEdit(matchId); 
                messageArea.textContent = `Status LIVE meczu ${matchId} zmieniony na: ${newLiveStatus ? 'WŁĄCZONY' : 'WYŁĄCZONY'}. Inne mecze LIVE wyłączone.`;
                messageArea.className = "message-area success";
            })
            .catch(error => {
                messageArea.textContent = "Błąd zmiany statusu LIVE: " + error.message;
                messageArea.className = "message-area error";
            });
    });

    document.getElementById('delete-match-btn').addEventListener('click', function() {
        const matchId = document.getElementById('match-id-manage').value;
        const messageArea = document.getElementById('edit-match-message');

        if (!matchId) {
            messageArea.textContent = "Wybierz mecz do usunięcia.";
            messageArea.className = "message-area error";
            return;
        }

        if (!confirm(`Czy na pewno chcesz usunąć mecz ${matchId} (${allMatchesData[matchId]?.group || 'Brak Grupy'})? Tej operacji nie można cofnąć.`)) {
            return;
        }

        db.ref(MATCHES_PATH).child(matchId).remove()
            .then(() => {
                messageArea.textContent = `Mecz ${matchId} został pomyślnie usunięty.`;
                messageArea.className = "message-area success";
                document.getElementById('edit-match-form').style.display = 'none';
                loadMatchAndTeamData(); 
            })
            .catch(error => {
                messageArea.textContent = "Błąd usuwania meczu: " + error.message;
                messageArea.className = "message-area error";
            });
    });

    function loadTeamsForManagement() {
        const teamSelect = document.getElementById('select-team-manage');
        const teamOptions = ['<option value="">-- Wybierz drużynę --</option>'];
        Object.keys(allTeamsData).forEach(teamId => {
             const teamName = allTeamsData[teamId]?.name || teamId;
             teamOptions.push(`<option value="${teamId}">${teamName} (${teamId})</option>`);
        });
        teamSelect.innerHTML = teamOptions.join('');
        document.getElementById('edit-team-form').style.display = 'none';
    }

    document.getElementById('select-team-manage').addEventListener('change', function() {
        const teamId = this.value;
        const editForm = document.getElementById('edit-team-form');
        const playersContainer = document.getElementById('players-container');

        if (!teamId) {
            editForm.style.display = 'none';
            return;
        }

        editForm.style.display = 'block';
        const team = allTeamsData[teamId];
        playersContainer.innerHTML = ''; 

        const achievements = team.achievements ? team.achievements.join('\n') : '';
        document.getElementById('team-achievements').value = achievements;

        const players = team.players || {};
        Object.keys(players).forEach(playerId => {
            addPlayerInput(players[playerId].name, players[playerId].number);
        });

        document.getElementById('edit-team-message').textContent = '';
    });

    document.getElementById('add-player-btn').addEventListener('click', () => {
        addPlayerInput('', '');
    });

    function addPlayerInput(name = '', number = '') {
        const container = document.getElementById('players-container');
        const playerDiv = document.createElement('div');
        playerDiv.classList.add('player-entry');
        playerDiv.innerHTML = `
            <input type="number" class="player-number" value="${number}" min="0" max="99" placeholder="Nr">
            <input type="text" class="player-name" value="${name}" required placeholder="Imię i Nazwisko / Pseudonim">
            <button type="button" class="remove-player-btn"><i class="fas fa-trash"></i> Usuń</button>
        `;
        playerDiv.querySelector('.remove-player-btn').addEventListener('click', () => {
            playerDiv.remove();
        });
        container.appendChild(playerDiv);
    }

    document.getElementById('edit-team-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const teamId = document.getElementById('select-team-manage').value;
        const messageArea = document.getElementById('edit-team-message');
        
        const achievementsText = document.getElementById('team-achievements').value.trim();
        const achievementsArray = achievementsText 
            ? achievementsText.split(/[\n,]+/).map(item => item.trim()).filter(item => item.length > 0) 
            : [];

        const newPlayers = {};
        let playerIdCounter = 1;
        let allPlayersValid = true;

        document.querySelectorAll('#players-container .player-entry').forEach(entry => {
            const nameInput = entry.querySelector('.player-name').value.trim();
            const numberInput = entry.querySelector('.player-number').value.trim();

            if (nameInput.length === 0) {
                allPlayersValid = false;
                return;
            }

            const playerKey = 'player' + playerIdCounter; 
            newPlayers[playerKey] = {
                name: nameInput,
                number: numberInput ? parseInt(numberInput) : null 
            };
            playerIdCounter++;
        });

        if (!allPlayersValid) {
            messageArea.textContent = "Błąd: Niektórzy zawodnicy mają puste nazwy. Usuń lub uzupełnij pola.";
            messageArea.className = "message-area error";
            return;
        }

        const teamUpdateData = {
            achievements: achievementsArray,
            players: newPlayers 
        };

        db.ref(TEAMS_PATH_ROOT).child(teamId).update(teamUpdateData)
            .then(() => {
                messageArea.textContent = `Dane drużyny ${allTeamsData[teamId].name || teamId} zapisane pomyślnie.`;
                messageArea.className = "message-area success";
                loadMatchAndTeamData(); 
            })
            .catch(error => {
                messageArea.textContent = "Błąd zapisu danych drużyny: " + error.message;
                messageArea.className = "message-area error";
            });
    });

    // ===========================================
    // START APLIKACJI
    // ===========================================
    document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>
