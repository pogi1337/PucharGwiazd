<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admina</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }

    .container, .panel section {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    h2 {
      color: #1a73e8;
      margin-bottom: 15px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #d3d3d3;
      border-radius: 5px;
    }

    button {
      padding: 10px 15px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0c5edc;
    }

    .message {
      margin-top: 10px;
      font-weight: bold;
    }
    .error { color: red; }
    .success { color: green; }

    .match-card {
      background: #0a0a1f;
      border: 1px solid #0ff;
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      color: white;
    }
    .match-card h3 {
      color: #00bfff;
    }
    .match-card input, select {
      margin: 6px;
      padding: 6px;
      border-radius: 6px;
    }
    .match-card button {
      background: #007bff;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .match-card button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #1a73e8;
      color: white;
    }
  </style>
</head>
<body>

  <div id="login-box" class="container">
    <h2>Logowanie admina</h2>
    <input id="login-email" type="email" placeholder="Email">
    <input id="login-pass" type="password" placeholder="Has≈Ço">
    <button id="login-btn">Zaloguj</button>
    <div id="login-msg" class="message"></div>
  </div>

  <div id="admin-wrapper" style="display:none;">
    <div class="panel">
      <section>
        <h2>Dodaj mecz</h2>
        <input id="teamA" placeholder="Dru≈ºyna A">
        <input id="teamB" placeholder="Dru≈ºyna B">
        <input id="group" placeholder="Grupa (np. A)">
        <input id="match-date" type="date">
        <input id="match-time" type="time">
        <button id="add-match-btn">Dodaj mecz</button>
      </section>

      <section>
        <h2>Lista mecz√≥w</h2>
        <label>Status: 
          <select id="match-status-filter">
            <option value="planowany">Planowany</option>
            <option value="trwa">Trwa</option>
            <option value="zako≈Ñczony">Zako≈Ñczony</option>
          </select>
        </label>
        <div id="matches-list"></div>
      </section>

      <section>
        <h2>Tabele grup</h2>
        <div id="group-tables"></div>
      </section>

      <section>
        <h2>Klasyfikacja strzelc√≥w</h2>
        <table id="scorers-table">
          <thead>
            <tr><th>Imiƒô i nazwisko</th><th>Dru≈ºyna</th><th>Gole</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
      authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
      projectId: "puchargwiazd-bdaa4",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // üîπ LOGOWANIE ADMINA
    document.getElementById("login-btn").addEventListener("click", async () => {
      const email = document.getElementById("login-email").value;
      const pass = document.getElementById("login-pass").value;
      const msg = document.getElementById("login-msg");

      msg.textContent = "Logowanie...";
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        const uid = cred.user.uid;
        const docSnap = await db.collection("users").doc(uid).get();

        if (!docSnap.exists || docSnap.data().admin !== true) {
          msg.textContent = "Brak uprawnie≈Ñ admina.";
          msg.className = "message error";
          await auth.signOut();
          return;
        }

        msg.textContent = "‚úÖ Zalogowano!";
        msg.className = "message success";
        document.getElementById("login-box").style.display = "none";
        document.getElementById("admin-wrapper").style.display = "block";

        loadMatches();
        loadTables();

      } catch (err) {
        msg.textContent = "B≈ÇƒÖd logowania: " + err.message;
        msg.className = "message error";
      }
    });

    // üîπ DODAWANIE MECZU
    document.getElementById("add-match-btn").addEventListener("click", async () => {
      const teamA = document.getElementById("teamA").value.trim();
      const teamB = document.getElementById("teamB").value.trim();
      const group = document.getElementById("group").value.trim();
      const date = document.getElementById("match-date").value;
      const time = document.getElementById("match-time").value;

      if (!teamA || !teamB || !group || !date || !time) return alert("Uzupe≈Çnij wszystkie pola!");

      await db.collection("matches").add({
        teamA, teamB, group, date, time,
        goalsA: 0, goalsB: 0,
        status: "planowany",
        scorers: [],
        createdAt: new Date()
      });

      alert("‚úÖ Mecz dodany!");
      loadMatches();
    });

    // üîπ WCZYTYWANIE MECZ√ìW
    async function loadMatches() {
      const statusFilter = document.getElementById("match-status-filter").value;
      const list = document.getElementById("matches-list");
      list.innerHTML = "<p>≈Åadowanie...</p>";

      const snapshot = await db.collection("matches")
        .where("status", "==", statusFilter)
        .orderBy("date")
        .get();

      list.innerHTML = "";
      snapshot.forEach(doc => {
        const m = doc.data();
        const div = document.createElement("div");
        div.className = "match-card";
        div.innerHTML = `
          <div><strong>${m.teamA} (${m.goalsA}) vs (${m.goalsB}) ${m.teamB}</strong></div>
          <small>${m.date} ${m.time}</small>
          <div>${m.scorers.map(s => `${s.name} (${s.team})`).join(", ") || "Brak strzelc√≥w"}</div>
          <div>
            <input id="ga-${doc.id}" type="number" value="${m.goalsA}" style="width:60px;">
            <input id="gb-${doc.id}" type="number" value="${m.goalsB}" style="width:60px;">
            <button onclick="updateScore('${doc.id}')">üíæ Zapisz</button>
            <button onclick="deleteMatch('${doc.id}')">üóë Usu≈Ñ</button>
          </div>
          <div>
            <input id="scorer-${doc.id}" placeholder="Dodaj strzelca">
            <select id="team-${doc.id}">
              <option value="${m.teamA}">${m.teamA}</option>
              <option value="${m.teamB}">${m.teamB}</option>
            </select>
            <button onclick="addScorer('${doc.id}')">‚öΩ Dodaj gola</button>
          </div>
          <div>
            <select id="status-${doc.id}">
              <option value="planowany" ${m.status==="planowany"?"selected":""}>Planowany</option>
              <option value="trwa" ${m.status==="trwa"?"selected":""}>Trwa</option>
              <option value="zako≈Ñczony" ${m.status==="zako≈Ñczony"?"selected":""}>Zako≈Ñczony</option>
            </select>
            <button onclick="changeStatus('${doc.id}')">üîÑ Zmie≈Ñ status</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function changeStatus(id) {
      const status = document.getElementById(`status-${id}`).value;
      await db.collection("matches").doc(id).update({ status });
      loadMatches();
      loadTables();
    }

    async function updateScore(id) {
      const ga = parseInt(document.getElementById(`ga-${id}`).value);
      const gb = parseInt(document.getElementById(`gb-${id}`).value);
      await db.collection("matches").doc(id).update({ goalsA: ga, goalsB: gb });
      loadMatches();
      loadTables();
    }

    async function addScorer(id) {
      const name = document.getElementById(`scorer-${id}`).value.trim();
      const team = document.getElementById(`team-${id}`).value;
      if (!name) return alert("Podaj nazwisko strzelca!");
      const matchRef = db.collection("matches").doc(id);
      await matchRef.update({
        scorers: firebase.firestore.FieldValue.arrayUnion({ name, team })
      });
      document.getElementById(`scorer-${id}`).value = "";
      loadMatches();
      loadTables();
    }

    async function deleteMatch(id) {
      if (!confirm("Czy na pewno chcesz usunƒÖƒá mecz?")) return;
      await db.collection("matches").doc(id).delete();
      loadMatches();
      loadTables();
    }

    async function loadTables() {
      const snapshot = await db.collection("matches").get();
      const teams = {};
      const scorersMap = {};

      snapshot.forEach(doc => {
        const m = doc.data();
        if (!teams[m.group]) teams[m.group] = {};
        [m.teamA, m.teamB].forEach(t => {
          if (!teams[m.group][t]) teams[m.group][t] = { pts: 0, gf: 0, ga: 0 };
        });

        if (m.status === "zako≈Ñczony") {
          teams[m.group][m.teamA].gf += m.goalsA;
          teams[m.group][m.teamA].ga += m.goalsB;
          teams[m.group][m.teamB].gf += m.goalsB;
          teams[m.group][m.teamB].ga += m.goalsA;
          if (m.goalsA > m.goalsB) teams[m.group][m.teamA].pts += 3;
          else if (m.goalsA < m.goalsB) teams[m.group][m.teamB].pts += 3;
          else { teams[m.group][m.teamA].pts += 1; teams[m.group][m.teamB].pts += 1; }
        }

        if (m.scorers) {
          m.scorers.forEach(s => {
            const key = s.name + " | " + s.team;
            scorersMap[key] = (scorersMap[key] || 0) + 1;
          });
        }
      });

      const groupDiv = document.getElementById("group-tables");
      groupDiv.innerHTML = "";
      for (const g in teams) {
        const tbl = document.createElement("table");
        tbl.innerHTML = `<tr><th>Grupa ${g}</th><th>PKT</th><th>GF</th><th>GA</th></tr>`;
        const sorted = Object.entries(teams[g]).sort((a,b)=>b[1].pts-a[1].pts);
        sorted.forEach(([t,v])=>{
          const row = document.createElement("tr");
          row.innerHTML = `<td>${t}</td><td>${v.pts}</td><td>${v.gf}</td><td>${v.ga}</td>`;
          tbl.appendChild(row);
        });
        groupDiv.appendChild(tbl);
      }

      const scorersTable = document.querySelector("#scorers-table tbody");
      scorersTable.innerHTML = "";
      const sortedScorers = Object.entries(scorersMap).sort((a,b)=>b[1]-a[1]);
      sortedScorers.forEach(([key, goals])=>{
        const [name, team] = key.split(" | ");
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${team}</td><td>${goals}</td>`;
        scorersTable.appendChild(tr);
      });
    }

    document.getElementById("match-status-filter").addEventListener("change", loadMatches);
  </script>
</body>
</html>
