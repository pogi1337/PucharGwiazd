<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Puchar Gwiazd</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* =========================================== */
        /* ZMIENNE KOLORYSTYCZNE (CZARNO-NIEBIESKIE) */
        /* =========================================== */
        :root {
            --primary-color: #007bff; /* Główny niebieski */
            --secondary-color: #adb5bd; /* Jasnoszary dla tekstu/ikon */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-start: #0d1a26; /* Bardzo ciemny/prawie czarny */
            --background-end: #212121; /* Ciemny szary */
            --card-bg: #343a40; /* Ciemne tło kart */
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            --header-bg: #1c2733;
        }

        body {
            font-family: 'Roboto', sans-serif; margin: 0; padding: 0;
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            color: #f8f9fa; min-height: 100vh;
        }
        
        /* Główne sekcje */
        .header {
            background-color: var(--header-bg); padding: 20px;
            color: white; border-bottom: 3px solid var(--primary-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-family: 'Montserrat', sans-serif; margin: 0; font-size: 1.5em; }
        .main-content { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Karta/Kontener */
        .container {
            margin-top: 25px; padding: 20px;
            background: var(--card-bg); border-radius: 10px;
            box-shadow: var(--card-shadow); border: 1px solid #495057;
        }
        h2 { color: var(--primary-color); border-bottom: 2px solid #495057; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Formularz i inputy */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--secondary-color); font-weight: 500;}
        input[type="email"], input[type="password"], input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #495057; border-radius: 5px;
            background-color: #2b3035; color: #f8f9fa; box-sizing: border-box;
        }
        select { height: 40px; }
        
        .submit-btn, .logout-btn {
            background-color: var(--primary-color); color: white; padding: 10px 15px; border: none;
            border-radius: 5px; cursor: pointer; font-size: 0.9em; font-weight: bold;
            transition: background-color 0.3s;
        }
        .submit-btn:hover { background-color: #0056b3; }
        .logout-btn { background-color: var(--danger-color); }
        .logout-btn:hover { background-color: #bd2130; }

        /* Komunikaty */
        .message-area { padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 10px; text-align: center; }
        .message-area.success { background-color: #1e4d2b; color: #c3e6cb; border: 1px solid #1c7430; }
        .message-area.error { background-color: #58151c; color: #f5c6cb; border: 1px solid #721c24; }
        .message-area.info { background-color: #004085; color: #b8daff; border: 1px solid #0056b3; }
        
        /* Siatka sekcji */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        /* Style dla tabeli wyników (Sekcja 3) */
        .match-form { border: 1px solid #495057; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .match-header { font-weight: bold; margin-bottom: 10px; color: var(--secondary-color); }
        .score-inputs { display: flex; align-items: center; gap: 10px; }
        .score-inputs input { width: 60px; text-align: center; font-size: 1.1em; }
        .team-name { font-weight: bold; }
        .separator { margin: 0 5px; }
    </style>
</head>
<body>

    <div class="main-content" id="login-section">
        <div class="container" style="max-width: 400px; margin: 50px auto;">
            <h1 style="text-align: center;">Logowanie Admina</h1>
            <form id="admin-login-form">
                <div class="form-group">
                    <label for="admin-email">Email Admina:</label>
                    <input type="email" id="admin-email" required>
                </div>
                <div class="form-group">
                    <label for="admin-password">Hasło:</label>
                    <input type="password" id="admin-password" required>
                </div>
                <button type="submit" class="submit-btn">Zaloguj</button>
                <div id="login-message" class="message-area"></div>
            </form>
        </div>
    </div>

    <div id="admin-panel" style="display: none;">
        <div class="header">
            <h1>Panel Administracyjny Pucharu Gwiazd</h1>
            <button id="admin-logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Wyloguj</button>
        </div>

        <div class="main-content grid">
            
            <div class="container">
                <h2>1. Zarządzanie Drużynami</h2>
                <form id="team-management-form">
                    <div class="form-group">
                        <label for="teams-list">Wybierz Drużynę do Edycji (Nazwa/ID):</label>
                        <select id="teams-list" required></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="team-display-name">Nowa Nazwa Wyświetlana:</label>
                        <input type="text" id="team-display-name" placeholder="Pełna nazwa drużyny">
                    </div>

                    <div class="form-group">
                        <label for="team-players-display">Skład Drużyny (tylko podgląd):</label>
                        <textarea id="team-players-display" rows="5" disabled style="font-size: 0.8em;"></textarea>
                    </div>

                    <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Zapisz Zmiany Nazwy</button>
                    <div id="team-management-message" class="message-area"></div>
                </form>
            </div>

            <div class="container">
                <h2>2. Wprowadzanie Wyników Meczów</h2>
                <div id="match-results-container">
                    </div>
                <div id="match-results-message" class="message-area"></div>
            </div>

            <div class="container">
                <h2>3. Narzędzia Administracyjne</h2>
                
                <form id="generate-matches-form">
                    <h3><i class="fas fa-calendar-alt"></i> Generowanie Meczów</h3>
                    <div class="form-group">
                        <label for="match-type-select">Typ meczu (np. faza grupowa, ćwierćfinał):</label>
                        <input type="text" id="match-type-select" required placeholder="Np. Grupa A">
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-cogs"></i> Generuj Mecze Ligowe</button>
                    <small style="color: var(--secondary-color); display: block; margin-top: 5px;">Wygeneruje mecze 'każdy z każdym' dla wszystkich obecnych drużyn.</small>
                    <div id="generate-matches-message" class="message-area"></div>
                </form>

                <hr style="border-top: 1px solid #495057; margin: 20px 0;">

                <button id="clear-all-data-btn" class="submit-btn" style="background-color: #8b0000; margin-top: 10px;"><i class="fas fa-trash-alt"></i> Usuń WSZYSTKIE DANE Meczy i Drużyn</button>
                <div id="clear-data-message" class="message-area"></div>
            </div>

            <div class="container">
                <h2>4. Stwórz Konto Logowania dla Drużyny</h2>
                <form id="create-team-account-form">
                    
                    <div class="form-group">
                        <label for="new-team-name-input">Nazwa Nowej Drużyny:</label>
                        <input type="text" id="new-team-name-input" required placeholder="Np. 'Lwy Północy'">
                        <small style="color: #adb5bd;">Nazwa zostanie użyta jako ID w bazie danych (np. 'Lwy_Polnocy').</small>
                    </div>
                    <div class="form-group">
                        <label for="team-account-email">Email Kapitana (Login):</label>
                        <input type="email" id="team-account-email" required>
                    </div>
                    <div class="form-group">
                        <label for="team-account-password">Hasło (min. 6 znaków):</label>
                        <input type="password" id="team-account-password" required>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-user-plus"></i> Utwórz Konto/Drużynę</button>
                    <div id="team-account-message" class="message-area"></div>
                </form>
            </div>

        </div> 
    </div> <script>
        // UWAGA: ZMIEŃ TE KLUCZE NA SWOJE I PAMIĘTAJ O 'HTTPS://' PRZY databaseURL!
        const firebaseConfig = {
            apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo", 
            authDomain: "puchargwiazd-bdaa4.firebaseapp.com", 
            databaseURL: "https://puchargwiazd-bdaa4-default-rtdb.europe-west1.firebasedatabase.app/", // !!! Już jest HTTPS
            projectId: "puchargwiazd-bdaa4",
            storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
            messagingSenderId: "890734185883",
            appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
        };
        
        try {
            firebase.initializeApp(firebaseConfig); 
        } catch (e) {
            console.error("Błąd inicjalizacji Firebase:", e.message);
        }
// RESZTA KODU JS PONIŻEJ...

        const auth = firebase.auth(); 
        const db = firebase.database();
        const teamsRef = db.ref('teams');
        const matchesRef = db.ref('matches');

        let teamsData = {}; // Globalna przechowalnia danych drużyn

        // ===========================================
        // LOGIKA AUTORYZACJI
        // ===========================================

        function checkAuth() {
            auth.onAuthStateChanged(user => {
                const loginSection = document.getElementById('login-section');
                const adminPanel = document.getElementById('admin-panel');
                
                if (user) {
                    // Wymuś odświeżenie tokenu, aby uzyskać Custom Claim (admin)
                    user.getIdTokenResult(true) 
                        .then(idTokenResult => {
                            const isAdmin = idTokenResult.claims.admin;
                            
                            if (isAdmin) {
                                loginSection.style.display = 'none';
                                adminPanel.style.display = 'block';
                                loadTeamsForManagement();
                                loadMatchesForScoreInput();
                            } else {
                                // Zalogowany, ale nie jest adminem
                                alert("Brak uprawnień. Zaloguj się kontem administratora.");
                                auth.signOut();
                            }
                        })
                        .catch(error => {
                            console.error("Błąd pobierania tokena:", error);
                            auth.signOut();
                        });
                } else {
                    // Brak zalogowanego użytkownika
                    loginSection.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            });
        }

        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value; 
            const password = document.getElementById('admin-password').value;
            const
