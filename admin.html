// ==========================================
// 1. KONFIGURACJA FIREBASE
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
    authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
    projectId: "puchargwiazd-bdaa4",
    // Dodajemy databaseURL, jeśli używasz Realtime Database, ale tu działamy na Firestore
    storageBucket: "puchargwiazd-bdaa4.firebasestorage.app",
    messagingSenderId: "890734185883",
    appId: "1:890734185883:web:4868b8bbf66c4bc7dfe53e"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore(); // Używamy Firestore zgodnie ze screenem

// ==========================================
// 2. LOGOWANIE I WERYFIKACJA ADMINA
// ==========================================
const loginBox = document.getElementById('login-box');
const adminPanel = document.getElementById('admin-wrapper');
const loginMsg = document.getElementById('login-msg');

// Obsługa przycisku logowania
document.getElementById('login-btn').addEventListener('click', () => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;

    auth.signInWithEmailAndPassword(email, pass)
        .catch(err => {
            loginMsg.innerText = "Błąd: " + err.message;
            loginMsg.style.color = "red";
        });
});

// Nasłuchiwanie stanu zalogowania
auth.onAuthStateChanged(async user => {
    if (user) {
        // Sprawdź czy użytkownik ma rolę 'admin' w kolekcji users
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists && doc.data().role === 'admin') {
            loginBox.style.display = 'none';
            adminPanel.style.display = 'block';
            initAdminPanel(); // Uruchom funkcje panelu
        } else {
            loginMsg.innerText = "Brak uprawnień administratora.";
            auth.signOut();
        }
    } else {
        loginBox.style.display = 'block';
        adminPanel.style.display = 'none';
    }
});

// ==========================================
// 3. FUNKCJE PANELU (Po zalogowaniu)
// ==========================================

function initAdminPanel() {
    loadTeamsForSelect();
    loadMatches();
    loadScorers(); // Jeśli masz kolekcję strzelców
}

// --- A. ŁADOWANIE DRUŻYN DO SELECTÓW ---
async function loadTeamsForSelect() {
    const selectA = document.getElementById('teamA');
    const selectB = document.getElementById('teamB');
    const selectScorerTeam = document.getElementById('scorer-team');

    // Czyścimy
    selectA.innerHTML = ''; selectB.innerHTML = ''; selectScorerTeam.innerHTML = '';

    // Pobieramy drużyny z kolekcji 'teams'
    // ZAKŁADAM, że masz kolekcję "teams", gdzie dokumenty to drużyny
    const snapshot = await db.collection('teams').get();

    snapshot.forEach(doc => {
        const teamName = doc.data().name || doc.id; // Używamy nazwy lub ID
        
        const option = `<option value="${teamName}">${teamName}</option>`;
        selectA.innerHTML += option;
        selectB.innerHTML += option;
        selectScorerTeam.innerHTML += option;
    });
}

// --- B. DODAWANIE MECZU ---
document.getElementById('add-match-btn').addEventListener('click', async () => {
    const teamA = document.getElementById('teamA').value;
    const teamB = document.getElementById('teamB').value;
    const group = document.getElementById('group').value;
    const date = document.getElementById('match-date').value;
    const time = document.getElementById('match-time').value;

    if (!teamA || !teamB || !group) {
        alert("Wybierz drużyny i grupę!");
        return;
    }

    // Zapisujemy w formacie zgodnym z Twoim screenem + pola dla index.html
    await db.collection('matches').add({
        teamA: teamA,
        teamB: teamB,
        goalsA: 0,
        goalsB: 0,
        group: group,
        status: 'scheduled', // Domyślnie: planowany
        date: date,
        time: time,
        scorers: "" // Puste na start
    });

    alert("Mecz dodany!");
    loadMatches(); // Odśwież listę
});

// --- C. LISTA I EDYCJA MECZÓW ---
async function loadMatches() {
    const container = document.getElementById('matches-list');
    container.innerHTML = 'Ładowanie...';

    // Pobierz mecze, sortując np. po grupie (opcjonalnie)
    const snapshot = await db.collection('matches').orderBy('group').get();
    
    container.innerHTML = '';

    if (snapshot.empty) {
        container.innerHTML = '<p>Brak meczów.</p>';
        return;
    }

    snapshot.forEach(doc => {
        const m = doc.data();
        const id = doc.id;

        // Tłumaczenie statusu na polski dla Admina
        let statusPL = 'Planowany';
        if(m.status === 'live') statusPL = 'Trwa';
        if(m.status === 'finished') statusPL = 'Zakończony';

        const div = document.createElement('div');
        div.className = 'match-item-admin';
        div.style.border = "1px solid #333";
        div.style.margin = "10px 0";
        div.style.padding = "10px";
        div.style.background = "#222"; // Ciemne tło pod admin.css

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; color: white;">
                <strong>${m.teamA} vs ${m.teamB}</strong> 
                <span>(Gr. ${m.group})</span>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <input type="number" id="goalsA-${id}" value="${m.goalsA}" style="width:50px">
                :
                <input type="number" id="goalsB-${id}" value="${m.goalsB}" style="width:50px">
                
                <select id="status-${id}">
                    <option value="scheduled" ${m.status === 'scheduled' ? 'selected' : ''}>Planowany</option>
                    <option value="live" ${m.status === 'live' ? 'selected' : ''}>Trwa (Live)</option>
                    <option value="finished" ${m.status === 'finished' ? 'selected' : ''}>Zakończony</option>
                </select>

                <button onclick="updateMatch('${id}')">Zapisz wynik</button>
                <button onclick="deleteMatch('${id}')" style="background:red">X</button>
            </div>
        `;
        container.appendChild(div);
    });
}

// Funkcja aktualizacji (musi być globalna, bo wywoływana z HTML stringa)
window.updateMatch = async (id) => {
    const gA = parseInt(document.getElementById(`goalsA-${id}`).value);
    const gB = parseInt(document.getElementById(`goalsB-${id}`).value);
    const st = document.getElementById(`status-${id}`).value;

    await db.collection('matches').doc(id).update({
        goalsA: gA,
        goalsB: gB,
        status: st
    });
    alert("Zaktualizowano mecz!");
};

// Funkcja usuwania
window.deleteMatch = async (id) => {
    if(confirm("Usunąć ten mecz?")) {
        await db.collection('matches').doc(id).delete();
        loadMatches();
    }
};


// ==========================================
// 4. TWORZENIE DRUŻYNY (REJESTRACJA)
// ==========================================
// UWAGA: Rejestracja usera (createUserWithEmailAndPassword) wyloguje admina.
// Dlatego tutaj tylko tworzymy wpis w bazie, a rejestrację najlepiej robić w oddzielnym oknie incognito 
// lub użyć Cloud Functions. Dla uproszczenia – tworzymy tylko wpis w bazie 'teams', 
// a zakładamy, że konto kapitana utworzysz ręcznie w panelu Firebase Console Auth.

document.getElementById('create-team-btn').addEventListener('click', async () => {
    const name = document.getElementById('team-id').value; // Nazwa drużyny
    const email = document.getElementById('team-email').value;
    
    if(!name) return alert("Podaj nazwę drużyny");

    // 1. Dodaj do kolekcji 'teams' (żeby była widoczna w selectach i panelu kapitana)
    // Używamy .add() aby wygenerować ID, lub .doc(name) jeśli nazwy są unikalne
    await db.collection('teams').add({
        name: name,
        email: email,
        points: 0, // pod tabelę
        goalsScored: 0,
        goalsLost: 0
    });

    alert("Drużyna dodana do bazy! (Pamiętaj, aby utworzyć konto w Auth ręcznie w konsoli Firebase, jeśli nie masz skryptu node.js)");
    loadTeamsForSelect();
});


// ==========================================
// 5. KLASYFIKACJA STRZELCÓW (Opcjonalne)
// ==========================================
// To zapisuje do oddzielnej kolekcji 'scorers' dla łatwego wyświetlania tabeli
document.getElementById('add-scorer-btn').addEventListener('click', async () => {
    const name = document.getElementById('scorer-name').value;
    const team = document.getElementById('scorer-team').value;
    const goals = parseInt(document.getElementById('scorer-goals').value);

    if(!name || !team) return alert("Uzupełnij dane");

    await db.collection('scorers').add({
        name: name,
        team: team,
        goals: goals
    });
    
    loadScorers();
});

async function loadScorers() {
    const tbody = document.querySelector('#scorers-table tbody');
    tbody.innerHTML = '';

    const snapshot = await db.collection('scorers').orderBy('goals', 'desc').get();
    
    snapshot.forEach(doc => {
        const s = doc.data();
        const row = `
            <tr>
                <td>${s.name}</td>
                <td>${s.team}</td>
                <td>${s.goals}</td>
                <td><button onclick="deleteScorer('${doc.id}')">X</button></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

window.deleteScorer = async (id) => {
    if(confirm("Usunąć?")) {
        await db.collection('scorers').doc(id).delete();
        loadScorers();
    }
};

// ==========================================
// 6. NADAWANIE UPRAWNIEŃ ADMINA
// ==========================================
document.getElementById('grant-admin-btn').addEventListener('click', async () => {
    const email = document.getElementById('new-admin-email').value;
    alert("W wersji client-side musisz znać UID użytkownika, aby edytować jego rolę w 'users'. Najlepiej zrób to ręcznie w Firestore: znajdź usera po UID i zmień pole role: 'admin'.");
});
