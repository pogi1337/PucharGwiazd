<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administratora - Puchar Gwiazd</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f2f3f7;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1a73e8;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 25px;
    }
    h2 {
      color: #1a73e8;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    button:hover {
      background-color: #0c5edc;
    }
    .message-area {
      margin-top: 10px;
      font-weight: bold;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
    .info {
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-user-shield"></i> Panel Administratora</h1>
  </header>

  <!-- üîπ SEKCJA 1: Logowanie administratora -->
  <div class="container" id="login-section">
    <h2>1. Logowanie</h2>
    <form id="login-form">
      <div class="form-group">
        <label for="email">E-mail:</label>
        <input type="email" id="email" required />
      </div>
      <div class="form-group">
        <label for="password">Has≈Ço:</label>
        <input type="password" id="password" required />
      </div>
      <button type="submit"><i class="fas fa-sign-in-alt"></i> Zaloguj</button>
      <div id="login-message" class="message-area"></div>
    </form>
  </div>

  <!-- üîπ SEKCJA 2: Panel administratora (po zalogowaniu) -->
  <div class="container" id="admin-section" style="display: none;">
    <h2>2. Tworzenie konta dru≈ºyny</h2>
    <form id="create-team-form">
      <div class="form-group">
        <label for="team-id">ID Dru≈ºyny:</label>
        <input type="text" id="team-id" required />
      </div>
      <div class="form-group">
        <label for="team-email">E-mail Dru≈ºyny:</label>
        <input type="email" id="team-email" required />
      </div>
      <div class="form-group">
        <label for="team-password">Has≈Ço Dru≈ºyny:</label>
        <input type="password" id="team-password" required minlength="6" />
      </div>
      <button type="submit"><i class="fas fa-user-plus"></i> Utw√≥rz Dru≈ºynƒô</button>
      <div id="team-message" class="message-area"></div>
    </form>
  </div>

  <!-- üîπ SEKCJA 3: Nadawanie uprawnie≈Ñ administratora -->
  <div class="container" id="grant-admin-section" style="display: none;">
    <h2>3. Nadawanie uprawnie≈Ñ administratora</h2>
    <form id="grant-admin-form">
      <div class="form-group">
        <label for="admin-email-input">Adres e-mail u≈ºytkownika:</label>
        <input type="email" id="admin-email-input" required placeholder="np. jan.nowak@gmail.com">
      </div>
      <button type="submit"><i class="fas fa-user-shield"></i> Nadaj uprawnienia admina</button>
      <div id="grant-admin-message" class="message-area"></div>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-functions.js"></script>

  <script>
    // =============================
    // üî• Konfiguracja Firebase (PucharGwiazd)
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyC6r04aG6T5EYqJ4OClraYU5Jr34ffONwo",
      authDomain: "puchargwiazd-bdaa4.firebaseapp.com",
      projectId: "puchargwiazd-bdaa4",
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const functions = firebase.functions();

    // =============================
    // üîπ Logowanie administratora
    // =============================
    const loginForm = document.getElementById('login-form');
    const loginMessage = document.getElementById('login-message');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      loginMessage.textContent = "Logowanie...";
      loginMessage.className = "message-area info";

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        await user.getIdTokenResult(true);

        const tokenResult = await user.getIdTokenResult();
        const isAdmin = tokenResult.claims.admin === true;

        if (isAdmin) {
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('admin-section').style.display = 'block';
          document.getElementById('grant-admin-section').style.display = 'block';
        } else {
          loginMessage.textContent = "Brak uprawnie≈Ñ administracyjnych.";
          loginMessage.className = "message-area error";
          await auth.signOut();
        }
      } catch (error) {
        console.error("B≈ÇƒÖd logowania:", error);
        loginMessage.textContent = "B≈ÇƒÖd logowania: " + error.message;
        loginMessage.className = "message-area error";
      }
    });

    // =============================
    // üîπ Tworzenie konta dru≈ºyny
    // =============================
    const teamForm = document.getElementById('create-team-form');
    const teamMessage = document.getElementById('team-message');

    teamForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const teamId = document.getElementById('team-id').value.trim();
      const email = document.getElementById('team-email').value.trim();
      const password = document.getElementById('team-password').value.trim();

      teamMessage.textContent = "Tworzenie konta...";
      teamMessage.className = "message-area info";

      try {
        const createTeamUser = firebase.functions().httpsCallable('createTeamUser');
        const result = await createTeamUser({ teamId, email, password });
        if (result.data.success) {
          teamMessage.textContent = result.data.message;
          teamMessage.className = "message-area success";
          teamForm.reset();
        } else {
          teamMessage.textContent = result.data.error;
          teamMessage.className = "message-area error";
        }
      } catch (error) {
        console.error("B≈ÇƒÖd tworzenia dru≈ºyny:", error);
        teamMessage.textContent = "B≈ÇƒÖd: " + (error.message || "Nie uda≈Ço siƒô utworzyƒá dru≈ºyny.");
        teamMessage.className = "message-area error";
      }
    });

    // =============================
    // üîπ Nadawanie uprawnie≈Ñ admina
    // =============================
    document.getElementById('grant-admin-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('admin-email-input').value.trim();
      const messageArea = document.getElementById('grant-admin-message');

      if (!email) {
        messageArea.textContent = 'Podaj adres e-mail u≈ºytkownika.';
        messageArea.className = 'message-area error';
        return;
      }

      messageArea.textContent = 'Nadawanie uprawnie≈Ñ...';
      messageArea.className = 'message-area info';

      try {
        const grantAdminRole = firebase.functions().httpsCallable('setAdminRole');
        const result = await grantAdminRole({ email: email });
        messageArea.textContent = `‚úÖ ${result.data.message}`;
        messageArea.className = 'message-area success';
        document.getElementById('admin-email-input').value = '';
      } catch (error) {
        console.error("B≈ÇƒÖd nadawania uprawnie≈Ñ:", error);
        messageArea.textContent = '‚ùå B≈ÇƒÖd: ' + (error.message || 'Nie uda≈Ço siƒô nadaƒá roli admina.');
        messageArea.className = 'message-area error';
      }
    });
  </script>
</body>
</html>
